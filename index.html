<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Torrenueva">
<meta name="theme-color" content="#1f2421">
<title>Torrenueva Futsal</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='85'>‚öΩ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   PALETA  (extra√≠da de las 3 paletas de Coolors)
   Fondo:      #1f2421  (verde oscur√≠simo, paleta 3)
   Superficie: #216869  (teal oscuro, paleta 3)
   Card A:     #dce1de  (gris verdoso claro, paleta 3)
   Card B:     #9cc5a1  (verde menta, paleta 3)
   Card C:     #bbcea8  (verde sage, paleta 1)
   Acento:     #f0ec57  (amarillo puro, paleta 1)
   Verde:      #cbff4d  (verde lima, paleta 2)
   Urgencia 2: #e3d87e  (amarillo c√°lido, paleta 1)
   Urgencia 4: #748067  (oliva, paleta 1) ‚Üí texto con rojo
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
:root {
  --bg:    #1f2421;
  --bg1:   #252c28;
  --bg2:   #2c342f;
  --surf:  #216869;
  --txt:   #dce1de;
  --sub:   #748067;
  --sub2:  #3a4238;
  --bor:   #2e3830;

  --yel:   #f0ec57;   /* acento principal */
  --ylim:  #cbff4d;   /* pagado / positivo */
  --mint:  #9cc5a1;   /* neutro claro */
  --sage:  #bbcea8;   /* neutro m√°s claro */
  --warm:  #e3d87e;   /* √ó2 */
  --red:   #e07070;   /* √ó4 / error */

  --yel-a: rgba(240,236,87,.12);
  --ylim-a:rgba(203,255,77,.11);
  --warm-a:rgba(227,216,126,.12);
  --red-a: rgba(224,112,112,.12);

  --safe:  env(safe-area-inset-bottom, 0px);
  --r:     16px;
  --r2:    10px;
  --rcard: 14px;

  /* Card backgrounds ‚Äî sin degradados, colores planos de las paletas */
  --ca: #dce1de;
  --cb: #9cc5a1;
  --cc: #bbcea8;
  --cd: #2d4a3e;
  --ce: #233530;
  --cf: #1a2e2a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{
  font-family:'Manrope',system-ui,sans-serif;
  background:var(--bg);color:var(--txt);
  min-height:100dvh;
  padding-bottom:calc(90px + var(--safe));
  -webkit-font-smoothing:antialiased;
}
button{font-family:inherit;cursor:pointer}
input,select{font-family:inherit}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{
  position:sticky;top:0;z-index:90;
  background:var(--bg);
  border-bottom:1px solid var(--bor);
  padding:12px 16px;
  padding-top:max(12px,env(safe-area-inset-top,12px));
  display:flex;align-items:center;gap:11px;
}
.logo{
  width:34px;height:34px;flex-shrink:0;
  font-size:1.5rem;line-height:1;
  display:flex;align-items:center;justify-content:center;
}
.logo img{width:34px;height:34px;border-radius:8px;object-fit:cover;display:block}
.hdr-brand{flex:1;min-width:0}
.brand-line{font-size:.95rem;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.b1{color:var(--yel);font-weight:800;letter-spacing:-.3px}
.b2{color:var(--mint);font-weight:300;letter-spacing:.8px}
.brand-sub{font-size:.52rem;color:var(--sub);margin-top:3px;letter-spacing:1.5px;text-transform:uppercase;font-weight:500}
.admin-badge{
  display:none;background:var(--yel-a);border:1px solid rgba(240,236,87,.25);
  border-radius:20px;padding:5px 11px;font-size:.65rem;font-weight:700;
  color:var(--yel);flex-shrink:0;align-items:center;gap:5px;cursor:pointer;
}
.admin-badge.on{display:flex}
.admin-badge .x{opacity:.45;margin-left:2px}

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero{
  margin:12px;border-radius:var(--r);
  background:var(--bg1);
  border:1px solid var(--bor);
  padding:20px 20px 16px;
}
.hero-lbl{font-size:.55rem;color:var(--sub);text-transform:uppercase;letter-spacing:2.5px;font-weight:600}
.hero-amt{font-size:3rem;font-weight:800;color:var(--txt);line-height:1;margin:6px 0 3px;letter-spacing:-2.5px}
.hero-amt .eur{color:var(--yel);font-weight:300;font-size:2rem}
.hero-cnt{font-size:.6rem;color:var(--sub);font-weight:500;letter-spacing:.3px}
.pills{display:flex;gap:6px;margin-top:13px;flex-wrap:wrap}
.pill{
  background:var(--bg2);border:1px solid var(--bor);border-radius:6px;
  padding:4px 10px;font-size:.62rem;font-weight:600;color:var(--sub);
  display:flex;align-items:center;gap:4px;
}
.pill b{color:var(--txt)}
.pill.g{background:var(--ylim-a);border-color:rgba(203,255,77,.2);color:var(--ylim)}
.pill.g b{color:var(--ylim)}
.pill.y{background:var(--yel-a);border-color:rgba(240,236,87,.2);color:var(--yel)}
.pill.y b{color:var(--yel)}

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.sec{
  font-size:.53rem;color:var(--sub2);font-weight:700;
  text-transform:uppercase;letter-spacing:2.5px;
  padding:0 14px;margin:18px 0 10px;
  display:flex;align-items:center;gap:8px;
}
.sec::after{content:'';flex:1;height:1px;background:var(--bor)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER CARDS
   Alternamos entre cards claras (tipo ca/cb/cc)
   y cards oscuras (tipo cd/ce/cf) para contraste
   
   Urgencia: borde COMPLETO coloreado
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.cards-wrap{padding:0 12px}

.pc{
  border-radius:var(--rcard);
  overflow:hidden;
  margin-bottom:12px;
  border:2px solid transparent;          /* borde por defecto = invisible */
  box-shadow:0 2px 8px rgba(0,0,0,.35);
  transition:transform .12s;
}
.pc:active{transform:scale(.987)}

/* Backgrounds planos, sin gradientes ‚Äî alternamos claro/oscuro */
.pc.ca{ background:var(--ca); color:#1f2421 }
.pc.cb{ background:var(--cb); color:#1f2421 }
.pc.cc{ background:var(--cc); color:#1f2421 }
.pc.cd{ background:var(--cd); color:var(--txt) }
.pc.ce{ background:var(--ce); color:var(--txt) }
.pc.cf{ background:var(--cf); color:var(--txt) }

/* Texto secundario adaptado seg√∫n fondo */
.pc.ca .dim,.pc.cb .dim,.pc.cc .dim{ color:rgba(31,36,33,.45) }
.pc.cd .dim,.pc.ce .dim,.pc.cf .dim{ color:rgba(220,225,222,.4) }

/* BORDE URGENCIA ‚Äî cubre los 4 lados */
.pc.w2{ border-color:var(--warm) !important }
.pc.w4{ border-color:var(--red)  !important }

/* header de tarjeta */
.pc-hdr{
  display:flex;align-items:center;gap:12px;
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(0,0,0,.08);
}
.pc.cd .pc-hdr,.pc.ce .pc-hdr,.pc.cf .pc-hdr{border-bottom-color:rgba(255,255,255,.06)}
.pc-em{font-size:1.9rem;line-height:1;flex-shrink:0}
.pc-info{flex:1;min-width:0}
.pc-name{font-size:1rem;font-weight:800;letter-spacing:-.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pc-meta{font-size:.57rem;font-weight:600;margin-top:3px;display:flex;align-items:center;gap:7px;letter-spacing:.2px}
.pc-lv{color:#49a078}
.pc-tot{font-size:1.55rem;font-weight:800;letter-spacing:-1.5px;flex-shrink:0}

/* Grid 2 columnas multas peque√±as */
.pc-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px}

/* Tarjeta multa individual */
.fc{
  border-radius:var(--r2);
  padding:9px 10px;
  display:flex;flex-direction:column;gap:3px;
  border:1.5px solid rgba(0,0,0,.07);
}
/* fondo de fc seg√∫n card padre */
.pc.ca .fc,.pc.cb .fc,.pc.cc .fc{background:rgba(0,0,0,.06)}
.pc.cd .fc,.pc.ce .fc,.pc.cf .fc{background:rgba(0,0,0,.2);border-color:rgba(255,255,255,.04)}

/* urgencia fc ‚Äî tambi√©n borde completo */
.fc.f2{border-color:var(--warm) !important}
.fc.f4{border-color:var(--red)  !important}

.fc-amt{font-size:1.25rem;font-weight:800;letter-spacing:-1px;line-height:1}
.fc-amt.or{color:#8a5a00}
.fc-amt.rd{color:#c03030}
.pc.cd .fc-amt.or,.pc.ce .fc-amt.or,.pc.cf .fc-amt.or{color:var(--warm)}
.pc.cd .fc-amt.rd,.pc.ce .fc-amt.rd,.pc.cf .fc-amt.rd{color:var(--red)}

.fc-rsn{
  font-size:.68rem;font-weight:500;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  overflow:hidden;line-height:1.3;
}
.fc-bot{font-size:.55rem;font-weight:600;display:flex;align-items:center;justify-content:space-between;margin-top:2px;letter-spacing:.2px}
.bdg{font-size:.5rem;padding:1px 5px;border-radius:4px;font-weight:700;letter-spacing:.3px}
.bdg.x2{background:rgba(227,216,126,.25);color:#6b5000}
.bdg.x4{background:rgba(224,112,112,.2);color:#a02020}
.pc.cd .bdg.x2,.pc.ce .bdg.x2,.pc.cf .bdg.x2{background:rgba(227,216,126,.15);color:var(--warm)}
.pc.cd .bdg.x4,.pc.ce .bdg.x4,.pc.cf .bdg.x4{background:rgba(224,112,112,.12);color:var(--red)}

.fc-btns{display:flex;gap:4px;margin-top:6px}
.pbtn{
  flex:1;border:1.5px solid rgba(0,0,0,.15);background:rgba(0,0,0,.08);
  color:inherit;border-radius:7px;padding:5px 0;
  font-size:.6rem;font-weight:700;transition:all .12s;
}
.pbtn:active{background:var(--yel);border-color:var(--yel);color:#1f2421}
.pc.cd .pbtn,.pc.ce .pbtn,.pc.cf .pbtn{border-color:rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:var(--txt)}
.dbtn{
  background:transparent;border:1.5px solid rgba(0,0,0,.1);
  color:rgba(0,0,0,.35);border-radius:7px;padding:5px 8px;font-size:.68rem;transition:all .12s;
}
.dbtn:active{border-color:var(--red);color:var(--red)}
.pc.cd .dbtn,.pc.ce .dbtn,.pc.cf .dbtn{border-color:rgba(255,255,255,.08);color:rgba(255,255,255,.25)}

/* ‚îÄ‚îÄ TABBAR ‚îÄ‚îÄ */
.nav-wrap{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;align-items:center;justify-content:center;gap:9px;
  padding:8px 14px;
  padding-bottom:max(10px,calc(var(--safe) + 4px));
  pointer-events:none;
  background:linear-gradient(to top,var(--bg) 60%,transparent);
}
.bnav{
  display:flex;flex:1;max-width:360px;
  background:var(--bg1);
  border:1px solid var(--bor);
  border-radius:14px;padding:4px;
  box-shadow:0 4px 24px rgba(0,0,0,.5);
  pointer-events:all;
}
.ni{
  flex:1;display:flex;flex-direction:column;align-items:center;
  gap:2px;background:transparent;border:none;color:var(--sub2);
  padding:6px 2px;border-radius:10px;transition:background .15s,color .15s;
}
.ni .ic{font-size:1.1rem;line-height:1;transition:transform .15s}
.ni .lb{font-size:.48rem;font-weight:700;letter-spacing:.3px;text-transform:uppercase;transition:color .15s}
.ni.on{background:var(--bg2);color:var(--yel)}
.ni.on .ic{transform:scale(1.12)}
.ni.on .lb{color:var(--yel)}
.ni:active .ic{transform:scale(.85)}
.fab{
  width:50px;height:50px;border-radius:12px;border:none;
  background:var(--yel);color:#1f2421;font-size:1.5rem;font-weight:800;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 20px rgba(240,236,87,.3),0 2px 6px rgba(0,0,0,.35);
  pointer-events:all;flex-shrink:0;transition:transform .1s,box-shadow .15s;
}
.fab:active{transform:scale(.88);box-shadow:0 2px 10px rgba(240,236,87,.2)}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pg{display:none;animation:pgIn .16s ease}
.pg.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ */
.rksec{margin:0 12px 12px}
.rkhead{
  background:var(--bg2);border-radius:var(--r) var(--r) 0 0;
  border:1px solid var(--bor);border-bottom:none;
  padding:9px 14px;font-size:.54rem;color:var(--sub);
  text-transform:uppercase;letter-spacing:2px;font-weight:700;
  display:flex;align-items:center;gap:6px;
}
.rkhead .dot{width:5px;height:5px;border-radius:50%;background:var(--yel);flex-shrink:0}
.rklist{background:var(--bg1);border-radius:0 0 var(--r) var(--r);overflow:hidden;border:1px solid var(--bor);border-top:none}
.rkrow{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--bor)}
.rkrow:last-child{border-bottom:none}
.rkpos{font-size:.68rem;font-weight:700;width:16px;text-align:center;flex-shrink:0;color:var(--sub2)}
.rkpos.g{color:var(--yel)}.rkpos.s{color:#5a5a5a}.rkpos.b{color:var(--sub2)}
.rkem{font-size:1.05rem;flex-shrink:0}
.rknm{flex:1;font-size:.83rem;font-weight:600}
.rkam{font-size:.9rem;font-weight:700;color:var(--red)}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(74px,1fr));gap:6px;padding:0 12px}
.cc-card{background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);padding:10px 5px;text-align:center}
.cc-em{font-size:1.4rem}
.cc-nm{font-size:.55rem;font-weight:700;color:var(--ylim);margin-top:5px;letter-spacing:.3px;text-transform:uppercase}

/* ‚îÄ‚îÄ VIDAS ‚îÄ‚îÄ */
.lc-wrap{padding:0 12px}
.lc{
  background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);
  display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:7px;
}
.lc-em{font-size:1.5rem;flex-shrink:0}
.lc-nm{flex:1;font-size:.85rem;font-weight:700}
.lc-eu{font-size:.95rem;font-weight:700;color:var(--ylim)}
.lc-z{font-size:.67rem;font-weight:600;color:var(--sub2)}
.log-box{margin:0 12px;background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);overflow:hidden}
.log-r{display:flex;align-items:center;gap:10px;padding:10px 13px;border-bottom:1px solid var(--bor)}
.log-r:last-child{border-bottom:none}
.log-d{font-size:.84rem;font-weight:700;flex-shrink:0;width:50px;text-align:right}
.log-d.p{color:var(--ylim)}.log-d.n{color:var(--red)}
.log-i{flex:1;min-width:0}
.log-nm{font-size:.79rem;font-weight:700}
.log-rs{font-size:.65rem;font-weight:500;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.log-dt{font-size:.55rem;font-weight:600;color:var(--sub2);flex-shrink:0}

/* ‚îÄ‚îÄ EQUIPO ‚îÄ‚îÄ */
.kit-wrap{margin:0 12px;border-radius:var(--rcard);overflow:hidden;display:flex;background:var(--bg1);border:1px solid var(--bor)}
.kit-img{width:88px;height:108px;object-fit:cover;flex-shrink:0}
.kit-info{padding:13px;flex:1}
.kit-info h3{font-size:.52rem;color:var(--yel);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:7px}
.kit-rule{font-size:.72rem;color:var(--sub);line-height:1.9;font-weight:500}
.kit-rule b{color:var(--txt)}
.rules-box{margin:0 12px;background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);overflow:hidden}
.rule{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--bor)}
.rule:last-child{border-bottom:none}
.rule-nm{font-size:.8rem;font-weight:600}
.rule-vl{font-size:.8rem;font-weight:700;color:var(--yel)}
.rule-nt{font-size:.62rem;font-weight:600;color:var(--sub2)}
.pl-box{margin:0 12px;background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);overflow:hidden}
.pl-r{display:flex;align-items:center;gap:10px;padding:10px 13px;border-bottom:1px solid var(--bor)}
.pl-r:last-child{border-bottom:none}
.pl-em{font-size:1.15rem;flex-shrink:0}
.pl-nm{flex:1;font-size:.82rem;font-weight:700}
.pl-lv{font-size:.66rem;font-weight:700;color:var(--ylim);margin-right:4px}
.pl-del{background:transparent;border:1px solid var(--bor);color:var(--sub);border-radius:6px;padding:3px 9px;font-size:.62rem;font-weight:600;transition:all .12s}
.pl-del:active{border-color:var(--red);color:var(--red)}
.add-row{display:flex;gap:7px;margin:8px 12px}
.add-row input{flex:1;background:var(--bg1);border:1px solid var(--bor);border-radius:9px;color:var(--txt);padding:10px 12px;font-size:.82rem;font-weight:600;outline:none;transition:border-color .15s}
.add-row input:focus{border-color:var(--yel)}
.add-row button{background:var(--yel);color:#1f2421;border:none;border-radius:9px;padding:10px 14px;font-size:.78rem;font-weight:800;flex-shrink:0}
.ibox{margin:8px 12px;background:var(--bg1);border:1px solid var(--bor);border-radius:var(--rcard);padding:12px 14px}
.ibox-lbl{font-size:.52rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:5px}
.ibox-txt{font-size:.74rem;color:var(--sub);line-height:1.7;font-weight:500}
.ibox-txt b{color:var(--txt)}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.ov{display:none;position:fixed;inset:0;z-index:200;background:rgba(10,14,12,.78);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);align-items:flex-end;justify-content:center}
.ov.on{display:flex}
.ov.ctr{align-items:center}
.sheet{
  width:100%;max-width:480px;
  background:var(--bg1);
  border-top-left-radius:20px;border-top-right-radius:20px;
  border:1px solid var(--bor);border-bottom:none;
  padding:10px 18px 24px;
  padding-bottom:max(26px,calc(var(--safe)+18px));
  animation:su .22s cubic-bezier(.16,1,.3,1);
}
.handle{width:32px;height:3px;background:var(--bor);border-radius:2px;margin:10px auto 18px}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mbox{
  width:88%;max-width:300px;margin:auto;
  background:var(--bg1);border:1px solid var(--bor);border-radius:18px;
  padding:26px 20px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  animation:bi .16s ease;
}
@keyframes bi{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
.mtit{font-size:.97rem;font-weight:800;margin-bottom:3px;letter-spacing:-.2px}
.msub{font-size:.68rem;color:var(--sub);margin-bottom:16px;font-weight:500;letter-spacing:.2px}
.field{margin-bottom:10px}
.field label{display:block;font-size:.53rem;color:var(--sub);letter-spacing:1.5px;text-transform:uppercase;font-weight:700;margin-bottom:4px}
.field select,.field input{
  width:100%;background:var(--bg);border:1px solid var(--bor);
  border-radius:9px;color:var(--txt);padding:10px 12px;
  font-size:.85rem;font-weight:600;outline:none;
  transition:border-color .15s;-webkit-appearance:none;
}
.field select:focus,.field input:focus{border-color:var(--yel)}
.field select option{background:var(--bg1)}
.f-row{display:flex;gap:7px}
.f-row .field{flex:1}
/* Checkbox esMulta */
.check-row{
  display:flex;align-items:center;gap:10px;
  background:var(--bg);border:1px solid var(--bor);border-radius:9px;
  padding:10px 12px;margin-bottom:10px;cursor:pointer;
  transition:border-color .15s;
}
.check-row:has(input:checked){border-color:var(--yel);background:var(--yel-a)}
.check-row input[type=checkbox]{
  width:16px;height:16px;accent-color:var(--yel);flex-shrink:0;cursor:pointer;
}
.check-row label{font-size:.8rem;font-weight:700;cursor:pointer;flex:1}
.check-row .check-sub{font-size:.64rem;font-weight:500;color:var(--sub);margin-top:1px}
.bok{width:100%;background:var(--yel);color:#1f2421;border:none;border-radius:10px;padding:13px;font-size:.88rem;font-weight:800;margin-top:8px;letter-spacing:-.1px}
.bcan{width:100%;background:transparent;color:var(--sub);border:none;padding:9px;font-size:.77rem;font-weight:600;margin-top:3px}
.lv-prev{background:var(--ylim-a);border:1px solid rgba(203,255,77,.2);border-radius:9px;padding:10px 12px;margin-bottom:11px;font-size:.73rem;color:var(--ylim);line-height:1.6;font-weight:500;display:none}
.lv-prev b{color:var(--ylim)}

/* PIN */
.pin-tit{font-size:.97rem;font-weight:800;margin-bottom:3px}
.pin-sub{font-size:.62rem;color:var(--sub);margin-bottom:19px;font-weight:600;letter-spacing:.5px}
.pin-dots{display:flex;justify-content:center;gap:11px;margin-bottom:20px}
.pin-dot{width:11px;height:11px;border-radius:50%;background:var(--bg2);border:1px solid var(--bor);transition:all .15s}
.pin-dot.on{background:var(--yel);border-color:var(--yel)}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px}
.pk{
  background:var(--bg2);border:1px solid var(--bor);border-radius:10px;
  padding:13px;font-size:1.1rem;color:var(--txt);font-weight:700;transition:all .1s;
}
.pk:active{background:var(--yel);color:#1f2421;border-color:var(--yel)}
.pk.del{color:var(--sub);font-size:.84rem}
.pin-err{font-size:.62rem;color:var(--red);margin-top:10px;height:13px;letter-spacing:.5px;font-weight:600}
.pin-cancel{background:transparent;border:none;color:var(--sub);font-size:.72rem;font-weight:600;margin-top:12px;width:100%}

/* Action picker */
.act-btn{
  width:100%;border:1px solid var(--bor);border-radius:11px;padding:13px;
  font-size:.87rem;font-weight:800;margin-bottom:8px;background:var(--bg2);
  color:var(--txt);display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .1s;
}
.act-btn:active{background:var(--yel);color:#1f2421;border-color:var(--yel)}

.empty{text-align:center;color:var(--sub);padding:48px 20px}
.empty-ic{font-size:2.2rem;margin-bottom:10px;opacity:.3}
.empty p{font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.loading{text-align:center;font-size:.62rem;color:var(--sub2);font-weight:600;padding:36px;letter-spacing:.5px;text-transform:uppercase}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="logo">
    <img src="escudo.png" alt="" onerror="this.style.display='none'">
    <span style="display:block;font-size:1.5rem;line-height:1" id="logo-fallback">‚öΩ</span>
  </div>
  <div class="hdr-brand">
    <div class="brand-line"><span class="b1">TORRENUEVA</span><span class="b2">FUTSAL</span></div>
    <div class="brand-sub">Multas ¬∑ T25/26</div>
  </div>
  <div class="admin-badge" id="admin-badge" onclick="logoutAdmin()">
    üîì Admin <span class="x">‚úï</span>
  </div>
</header>

<!-- HERO -->
<div class="hero">
  <div class="hero-lbl">Total pendiente</div>
  <div class="hero-amt" id="h-total">‚Äî<span class="eur"></span></div>
  <div class="hero-cnt" id="h-count">cargando...</div>
  <div class="pills" id="h-pills"></div>
</div>

<!-- MULTAS -->
<div class="pg on" id="pg-multas">
  <div class="sec">Pendientes</div>
  <div id="fines-list"><div class="loading">cargando...</div></div>
</div>

<!-- VIDAS -->
<div class="pg" id="pg-lives">
  <div class="sec">Saldo de vidas</div>
  <div class="lc-wrap" id="lives-list"></div>
  <div class="sec">Historial</div>
  <div class="log-box" id="log-list"><div class="loading">cargando...</div></div>
  <div style="height:10px"></div>
</div>

<!-- RANKING -->
<div class="pg" id="pg-ranking">
  <div class="sec">Temporada 2025/26</div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-season"></div>
  </div>
  <div class="sec">Este mes ¬∑ <span id="month-lbl" style="font-size:.72rem;font-weight:700;color:var(--txt);text-transform:none;letter-spacing:0"></span></div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-month"></div>
  </div>
  <div class="rksec">
    <div class="rkhead"><div class="dot" style="background:var(--red)"></div>m√°s deuda</div>
    <div class="rklist" id="rk-debt"></div>
  </div>
  <div class="sec">Sin multas este mes</div>
  <div class="cgrid" id="clean-grid"></div>
  <div style="height:10px"></div>
</div>

<!-- EQUIPO -->
<div class="pg" id="pg-team">
  <div class="sec">Equipaci√≥n</div>
  <div class="kit-wrap">
    <img class="kit-img" src="equipacion.jpg" alt="" onerror="this.style.display='none'">
    <div class="kit-info">
      <h3>Kit oficial</h3>
      <div class="kit-rule"><b>Pantal√≥n</b> ‚Äî del club</div>
      <div class="kit-rule"><b>Medias</b> ‚Äî color oficial</div>
      <div class="kit-rule"><b>Camiseta</b> ‚Äî entregar limpia</div>
    </div>
  </div>
  <div class="sec">Jugadores</div>
  <div class="pl-box" id="player-list"></div>
  <div class="add-row" id="add-player-row" style="display:none">
    <input type="text" id="new-player-name" placeholder="Nombre del jugador">
    <button onclick="addPlayer()">+ A√±adir</button>
  </div>
  <div class="sec">Baremo de multas</div>
  <div class="rules-box">
    <div class="rule"><span class="rule-nm">Llegar tarde</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Pantal√≥n equivocado</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">No avisar ausencia</span><span class="rule-vl">2‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 15 d√≠as</span><span class="rule-nt">√ó2 auto</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 29 d√≠as</span><span class="rule-nt">√ó4 auto</span></div>
  </div>
  <div class="sec">Sistema de vidas</div>
  <div class="ibox">
    <div class="ibox-lbl">¬øC√≥mo funciona?</div>
    <div class="ibox-txt">Cada <b>vida = 1‚Ç¨</b>. Pagar de m√°s acumula cr√©dito que se usa autom√°ticamente en la siguiente multa.<br><br>Las multas que <b>no son multa</b> (checkbox desmarcado) no se duplican aunque pasen 15 d√≠as.</div>
  </div>
  <div class="sec">Instalar como app</div>
  <div class="ibox"><div class="ibox-lbl">iOS Safari</div><div class="ibox-txt"><b>Compartir</b> ‚Üí <b>A√±adir a pantalla de inicio</b></div></div>
  <div class="ibox"><div class="ibox-lbl">Android Chrome</div><div class="ibox-txt">Men√∫ <b>‚ãÆ</b> ‚Üí <b>Instalar app</b></div></div>
  <div style="height:10px"></div>
</div>

<!-- TABBAR -->
<div class="nav-wrap">
  <nav class="bnav">
    <button class="ni on" onclick="goPage('multas',this)"><div class="ic">üê∑</div><span class="lb">Multas</span></button>
    <button class="ni" onclick="goPage('lives',this)"><div class="ic">‚ù§Ô∏è</div><span class="lb">Vidas</span></button>
    <button class="ni" onclick="goPage('ranking',this)"><div class="ic">üèÜ</div><span class="lb">Ranking</span></button>
    <button class="ni" onclick="goPage('team',this)"><div class="ic">‚öΩ</div><span class="lb">Equipo</span></button>
  </nav>
  <button class="fab" onclick="fabTap()">+</button>
</div>

<!-- PIN -->
<div class="ov ctr" id="pin-ov">
  <div class="mbox">
    <div class="pin-tit">Acceso admin</div>
    <div class="pin-sub">PIN del capit√°n</div>
    <div class="pin-dots">
      <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-grid" id="pin-grid"></div>
    <div class="pin-err" id="pin-err"></div>
    <button class="pin-cancel" onclick="closePin()">Cancelar</button>
  </div>
</div>

<!-- MODAL: NUEVA MULTA/COBRO -->
<div class="ov" id="fine-ov">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mtit">Nuevo apunte</div>
    <div style="height:13px"></div>
    <div class="field">
      <label>Jugador</label>
      <select id="inp-player"><option value="">Seleccionar...</option></select>
    </div>
    <div class="f-row">
      <div class="field"><label>Importe (‚Ç¨)</label><input type="number" id="inp-amount" min="0.5" step="1" placeholder="1"></div>
      <div class="field"><label>Fecha</label><input type="date" id="inp-date"></div>
    </div>
    <div class="field"><label>Motivo</label><input type="text" id="inp-reason" placeholder="ej: lleg√≥ tarde..."></div>
    <!-- CHECKBOX esMulta -->
    <label class="check-row">
      <input type="checkbox" id="inp-esMulta" checked>
      <div>
        <div class="check-sub" style="font-size:.62rem;font-weight:600;color:var(--sub);margin-bottom:1px">TIPO DE APUNTE</div>
        <div style="font-size:.8rem;font-weight:700" id="esMulta-label">Es una multa ‚Äî duplica si no se paga</div>
      </div>
    </label>
    <button class="bok" onclick="addFine()">A√±adir</button>
    <button class="bcan" onclick="closeFineModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL: PAGAR MULTA -->
<div class="ov ctr" id="pay-ov">
  <div class="mbox">
    <div class="mtit" id="pay-tit">Pagar multa</div>
    <div class="msub" id="pay-sub"></div>
    <div class="lv-prev" id="lv-prev"></div>
    <div class="field">
      <label>Importe pagado (‚Ç¨)</label>
      <input type="number" id="pay-amt" min="0" step="1" placeholder="0">
    </div>
    <button class="bok" onclick="confirmPay()">Confirmar pago</button>
    <button class="bcan" onclick="closePayOv()">Cancelar</button>
  </div>
</div>

<script>
/* ================================================================ CONFIG */
const SUPA_URL     = 'https://cmfhosxslodnrxlpifrn.supabase.co';
const SUPA_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZmhvc3hzbG9kbnJ4bHBpZnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NDY2NTQsImV4cCI6MjA4NzIyMjY1NH0.c4-Zb79UQhshpzQH79gIoro3IBKEliEjBMlhjypa_dc';
const SEASON_START = new Date('2025-07-01');

// 6 clases alternadas para tarjetas ‚Äî claro/oscuro/claro/oscuro...
const PALETA = ['ca','cb','cc','cd','ce','cf'];
/* ================================================================ */

let isAdmin=false, pinBuf='', pendingAction=null;
let players=[], currentPayFine=null, ADMIN_PIN=null;
window._cached_fines=[];

/* ‚îÄ‚îÄ Supabase ‚îÄ‚îÄ */
async function sb(path,opts={}){
  const method=opts.method||'GET';
  const isW=['POST','PATCH','PUT'].includes(method);
  const h={'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY};
  if(isW){h['Content-Type']='application/json';h['Prefer']='return=representation';}
  if(method==='DELETE') h['Prefer']='return=minimal';
  Object.assign(h,opts.headers||{});
  const r=await fetch(SUPA_URL+'/rest/v1/'+path,{...opts,headers:h});
  if(!r.ok){const m=await r.text().catch(()=>r.statusText);throw new Error(`${r.status}: ${m}`);}
  const t=await r.text();return t?JSON.parse(t):[];
}
const getConfig   = ()     => sb('config?select=value&key=eq.admin_pin');
const getPlayers  = ()     => sb('players?active=eq.true&select=id,name,lives,emoji&order=name.asc');
const getAll      = ()     => sb('multas?order=date.desc');
const getLivesLog = ()     => sb('lives_log?order=created_at.desc&limit=60');
const postFine    = d      => sb('multas',  {method:'POST', body:JSON.stringify(d)});
const patchFine   = (id,d) => sb(`multas?id=eq.${id}`,   {method:'PATCH',body:JSON.stringify(d)});
const deleteFine  = id     => sb(`multas?id=eq.${id}`,   {method:'DELETE'});
const patchPlayer = (id,d) => sb(`players?id=eq.${id}`,  {method:'PATCH',body:JSON.stringify(d)});
const postPlayer  = name   => sb('players', {method:'POST',body:JSON.stringify({name})});
const postLivesLog= d      => sb('lives_log',{method:'POST',body:JSON.stringify(d)});

/* ‚îÄ‚îÄ L√≥gica de multiplicador ‚îÄ‚îÄ
   Solo duplica si esMulta === true.
   D√≠as 0‚Äì14: √ó1
   D√≠as 15‚Äì28: √ó2
   D√≠as 29+: √ó4
‚îÄ‚îÄ */
function daysSince(ds){
  return Math.floor((Date.now() - new Date(ds+'T12:00:00')) / 86400000);
}
function mult(f){
  if(!f.esMulta) return 1;
  const d = daysSince(f.date);
  if(d>=29) return 4;
  if(d>=15) return 2;
  return 1;
}
const eff = f => f.amount * mult(f);

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const fmt     = n  => (n%1===0?n:n.toFixed(2))+'‚Ç¨';
const fmtD    = ds => new Date(ds+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'short'});
const fmtDL   = ds => new Date(ds).toLocaleDateString('es-ES',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
const isSeason= ds => new Date(ds+'T12:00:00')>=SEASON_START;
const isMonth = ds => {const d=new Date(ds+'T12:00:00'),n=new Date();return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();};
const monthName=()=> new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'});
const posCls  = i  => ['g','s','b'][i]||'';
const liveStr = n  => {if(!n||n<=0)return'';return'‚ù§Ô∏è'.repeat(Math.floor(n))+(n-Math.floor(n)>0?'ü©∂':'');};
const emoji   = name=>{const p=players.find(x=>x.name===name);return p?.emoji||'üë§';};
const plColor = idx => PALETA[idx%PALETA.length];
const plLives = name=>{const p=players.find(x=>x.name===name);return p?parseFloat(p.lives||0):0;};

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
async function render(){
  let all,pls,log;
  try{
    [all,pls,log]=await Promise.all([getAll(),getPlayers(),getLivesLog()]);
    players=pls; window._cached_fines=all;
  }catch(e){
    console.error(e);
    document.getElementById('h-count').textContent='Error de conexi√≥n';
    return;
  }
  const pend=all.filter(f=>!f.paid);
  const paid=all.filter(f=>f.paid);
  const total=pend.reduce((s,f)=>s+eff(f),0);
  const lvTot=pls.reduce((s,p)=>s+parseFloat(p.lives||0),0);

  document.getElementById('h-total').innerHTML=fmt(total).replace('‚Ç¨','<span class="eur">‚Ç¨</span>');
  document.getElementById('h-count').textContent=
    pend.length+' apunte'+(pend.length!==1?'s':'')+' pendiente'+(pend.length!==1?'s':'');
  document.getElementById('month-lbl').textContent=monthName();
  document.getElementById('h-pills').innerHTML=
    `<div class="pill"><b>${pend.filter(f=>isSeason(f.date)).length}</b> esta temporada</div>
     <div class="pill"><b>${paid.filter(f=>isMonth(f.paid_at||f.date)).length}</b> pagados este mes</div>
     ${lvTot>0?`<div class="pill g"><b>${fmt(lvTot)}</b> en vidas</div>`:''}
     ${pend.filter(f=>mult(f)>1).length>0?`<div class="pill y"><b>${pend.filter(f=>mult(f)>1).length}</b> duplicadas</div>`:''}`;

  renderCards(pend,pls);
  renderLives(pls,log);
  renderRanking(all,paid,pls);
  renderPlayers(pls);
  rebuildSelect(pls);
}

/* ‚îÄ‚îÄ TARJETAS ‚îÄ‚îÄ */
function renderCards(pend,pls){
  const el=document.getElementById('fines-list');
  if(!pend.length){el.innerHTML='<div class="empty"><div class="empty-ic">üéâ</div><p>sin apuntes pendientes</p></div>';return;}

  // Agrupamos por jugador (orden de la lista de jugadores)
  const groups={};
  pls.forEach(p=>{groups[p.name]=[];});
  pend.forEach(f=>{if(!groups[f.player])groups[f.player]=[];groups[f.player].push(f);});

  let idx=0;
  el.innerHTML='<div class="cards-wrap">'+
    Object.entries(groups)
      .filter(([,ff])=>ff.length>0)
      .map(([player,ff])=>{
        const sorted=[...ff].sort((a,b)=>new Date(b.date)-new Date(a.date));
        const tot=ff.reduce((s,f)=>s+eff(f),0);
        const lives=plLives(player);
        const mx=Math.max(...ff.map(f=>mult(f)));
        const col=plColor(idx++);
        // borde urgencia en la card completa
        const urgCls=mx===4?'w4':mx===2?'w2':'';

        const fH=sorted.map(f=>{
          const m=mult(f),e=eff(f);
          const amtCls=m===4?'rd':m===2?'or':'';
          const fcCls=m===4?'f4':m===2?'f2':'';
          const bdg=m===4?`<span class="bdg x4">√ó4</span>`:m===2?`<span class="bdg x2">√ó2</span>`:'';
          const noMulta=!f.esMulta?`<span style="font-size:.5rem;opacity:.5;font-weight:600">cobro</span>`:'';
          const btns=isAdmin?`<div class="fc-btns">
            <button class="pbtn" onclick="openPayOv('${f.id}')">‚úì Pagar</button>
            <button class="dbtn" onclick="delFineAct('${f.id}')">üóë</button>
          </div>`:'';
          return`<div class="fc ${fcCls}">
            <div class="fc-amt ${amtCls}">${fmt(e)}</div>
            <div class="fc-rsn dim">${f.reason||'sin motivo'}</div>
            <div class="fc-bot dim"><span>${fmtD(f.date)}</span><span>${bdg}${noMulta}</span></div>
            ${btns}
          </div>`;
        }).join('');

        return`<div class="pc ${col} ${urgCls}">
          <div class="pc-hdr">
            <div class="pc-em">${emoji(player)}</div>
            <div class="pc-info">
              <div class="pc-name">${player}</div>
              <div class="pc-meta dim">
                <span>${ff.length} apunte${ff.length!==1?'s':''}</span>
                ${lives>0?`<span class="pc-lv">‚ù§Ô∏è ${fmt(lives)}</span>`:''}
              </div>
            </div>
            <div class="pc-tot">${fmt(tot)}</div>
          </div>
          <div class="pc-grid">${fH}</div>
        </div>`;
      }).join('')
  +'</div>';
}

/* ‚îÄ‚îÄ Vidas ‚îÄ‚îÄ */
function renderLives(pls,log){
  document.getElementById('lives-list').innerHTML=
    [...pls].sort((a,b)=>(b.lives||0)-(a.lives||0)).map(p=>{
      const lv=parseFloat(p.lives||0);
      return`<div class="lc">
        <div class="lc-em">${p.emoji||'üë§'}</div>
        <div class="lc-nm">${p.name}</div>
        ${lv>0?`<span style="margin-right:5px">${liveStr(lv)}</span><div class="lc-eu">${fmt(lv)}</div>`:`<span class="lc-z">sin vidas</span>`}
      </div>`;
    }).join('');
  const lel=document.getElementById('log-list');
  if(!log.length){lel.innerHTML='<div class="loading">sin movimientos a√∫n</div>';return;}
  lel.innerHTML=log.map(l=>`<div class="log-r">
    <div class="log-d ${l.delta>0?'p':'n'}">${l.delta>0?'+':''}${fmt(l.delta)}</div>
    <div class="log-i">
      <div class="log-nm">${emoji(l.player)} ${l.player}</div>
      <div class="log-rs">${l.reason||''}</div>
    </div>
    <div class="log-dt">${fmtDL(l.created_at)}</div>
  </div>`).join('');
}

/* ‚îÄ‚îÄ Ranking ‚îÄ‚îÄ */
function renderRanking(all,paid,pls){
  const sPaid=paid.filter(f=>isSeason(f.date));
  const sTot={};sPaid.forEach(f=>{sTot[f.player]=(sTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-season',sTot,true);
  const mPaid=paid.filter(f=>isMonth(f.paid_at||f.date));
  const mTot={};mPaid.forEach(f=>{mTot[f.player]=(mTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-month',mTot,true);
  const mPend=all.filter(f=>!f.paid&&isMonth(f.date));
  const dTot={};mPend.forEach(f=>{dTot[f.player]=(dTot[f.player]||0)+eff(f);});
  rkList('rk-debt',dTot,false);
  const dirty=new Set(mPend.map(f=>f.player));
  const clean=pls.filter(p=>!dirty.has(p.name));
  document.getElementById('clean-grid').innerHTML=clean.length
    ?clean.map(p=>`<div class="cc-card"><div class="cc-em">${p.emoji||'üë§'}</div><div class="cc-nm">${p.name.split(' ')[0]}</div></div>`).join('')
    :'<p style="color:var(--sub2);font-size:.62rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;padding:2px 0">nadie limpio</p>';
}
function rkList(id,tots,desc){
  const el=document.getElementById(id);
  const s=Object.entries(tots).filter(([,v])=>v>0).sort((a,b)=>desc?b[1]-a[1]:a[1]-b[1]);
  if(!s.length){el.innerHTML='<div class="rkrow"><span style="font-size:.62rem;font-weight:600;color:var(--sub2)">sin datos a√∫n</span></div>';return;}
  el.innerHTML=s.map(([nm,tot],i)=>`<div class="rkrow">
    <span class="rkpos ${posCls(i)}">${i+1}</span>
    <span class="rkem">${emoji(nm)}</span>
    <span class="rknm">${nm}</span>
    <span class="rkam">${fmt(tot)}</span>
  </div>`).join('');
}

/* ‚îÄ‚îÄ Equipo ‚îÄ‚îÄ */
function renderPlayers(pls){
  document.getElementById('player-list').innerHTML=pls.map(p=>`
    <div class="pl-r">
      <span class="pl-em">${p.emoji||'üë§'}</span>
      <div class="pl-nm">${p.name}</div>
      ${parseFloat(p.lives||0)>0?`<span class="pl-lv">‚ù§Ô∏è ${fmt(parseFloat(p.lives))}</span>`:''}
      ${isAdmin?`<button class="pl-del" onclick="delPlayerAct('${p.id}')">Baja</button>`:''}
    </div>`).join('');
  document.getElementById('add-player-row').style.display=isAdmin?'flex':'none';
}
function rebuildSelect(pls){
  const sel=document.getElementById('inp-player');
  const prev=sel.value;
  sel.innerHTML='<option value="">Seleccionar...</option>';
  pls.forEach(p=>{const o=document.createElement('option');o.value=p.name;o.textContent=(p.emoji||'üë§')+' '+p.name;sel.appendChild(o);});
  if(prev) sel.value=prev;
}

/* ‚îÄ‚îÄ Checkbox label din√°mico ‚îÄ‚îÄ */
document.getElementById('inp-esMulta').addEventListener('change',function(){
  document.getElementById('esMulta-label').textContent=
    this.checked?'Es una multa ‚Äî duplica si no se paga':'Cobro o cargo ‚Äî no duplica';
});

/* ‚îÄ‚îÄ Pagar multa ‚îÄ‚îÄ */
function openPayOv(fineId){
  const f=(window._cached_fines||[]).find(x=>x.id===fineId);
  if(!f){alert('Recarga la p√°gina.');return;}
  currentPayFine=f;
  const e=eff(f),lives=plLives(f.player),ul=Math.min(lives,e),tp=Math.max(0,e-ul);
  document.getElementById('pay-tit').textContent=`Pagar ‚Äî ${f.player}`;
  document.getElementById('pay-sub').textContent=`Importe: ${fmt(e)}`;
  document.getElementById('pay-amt').value=tp;
  const prev=document.getElementById('lv-prev');
  if(lives>0){
    prev.style.display='block';
    prev.innerHTML=lives>=e?`‚ù§Ô∏è Cubre todo. Pago real: <b>${fmt(tp)}</b>`:`‚ù§Ô∏è ${fmt(ul)} en vidas. Resto: <b>${fmt(tp)}</b>`;
  }else prev.style.display='none';
  document.getElementById('pay-ov').classList.add('on');
}
function closePayOv(){document.getElementById('pay-ov').classList.remove('on');currentPayFine=null;}
document.getElementById('pay-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closePayOv();});

document.getElementById('pay-amt').addEventListener('input',()=>{
  if(!currentPayFine)return;
  const f=currentPayFine,e=eff(f),lives=plLives(f.player);
  const pi=parseFloat(document.getElementById('pay-amt').value)||0;
  const ul=Math.min(lives,e),ti=pi+ul,ex=Math.max(0,ti-e);
  const prev=document.getElementById('lv-prev');
  if(lives>0||ex>0){
    prev.style.display='block';
    let m='';
    if(ul>0) m+=`‚ù§Ô∏è Usa ${fmt(ul)} en vidas. `;
    if(ex>0) m+=`<b>+${fmt(ex)} vidas nuevas</b> por exceso.`;
    if(!m)   m='Sin vidas aplicadas.';
    prev.innerHTML=m;
  }
});

async function confirmPay(){
  if(!currentPayFine)return;
  const f=currentPayFine,e=eff(f),lives=plLives(f.player);
  const pi=parseFloat(document.getElementById('pay-amt').value)||0;
  const ul=Math.min(lives,e),ti=pi+ul,ex=Math.max(0,ti-e),nl=lives-ul+ex;
  const pl=players.find(p=>p.name===f.player);
  const today=new Date().toISOString().split('T')[0];
  const pm=mult(f);
  try{
    await patchFine(f.id,{paid:true,paid_mult:pm,paid_at:today,paid_amount:ti});
    if(pl) await patchPlayer(pl.id,{lives:nl});
    const log=[];
    if(ul>0) log.push({player:f.player,player_id:pl?.id,delta:-ul,reason:`Vidas usadas: "${f.reason||'sin motivo'}" (${fmt(e)})`});
    if(ex>0) log.push({player:f.player,player_id:pl?.id,delta:ex,reason:`Exceso ‚Üí vidas (${fmt(ex)})`});
    for(const l of log) await postLivesLog(l);
    closePayOv(); render();
  }catch(err){alert('Error: '+err.message);}
}

/* ‚îÄ‚îÄ Acciones ‚îÄ‚îÄ */
async function delFineAct(id){if(!confirm('¬øEliminar?'))return;await deleteFine(id);render();}
async function addFine(){
  const p=document.getElementById('inp-player').value;
  const a=parseFloat(document.getElementById('inp-amount').value);
  const d=document.getElementById('inp-date').value;
  const r=document.getElementById('inp-reason').value.trim();
  const esM=document.getElementById('inp-esMulta').checked;
  if(!p)return alert('Selecciona un jugador');
  if(!a||a<=0)return alert('Importe inv√°lido');
  if(!d)return alert('Selecciona fecha');
  try{
    await postFine({player:p,amount:a,date:d,reason:r,esMulta:esM});
    closeFineModal(); render();
  }catch(e){alert('Error: '+e.message);}
}
async function addPlayer(){
  const n=document.getElementById('new-player-name').value.trim();
  if(!n)return;
  try{await postPlayer(n);document.getElementById('new-player-name').value='';render();}
  catch(e){alert('Error: '+e.message);}
}
async function delPlayerAct(id){if(!confirm('¬øDar de baja?'))return;await patchPlayer(id,{active:false});render();}

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
function fabTap(){
  if(isAdmin){openFineModal();return;}
  pendingAction='fine'; openPin();
}
function logoutAdmin(){isAdmin=false;updUI();}

/* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
function openFineModal(){
  document.getElementById('inp-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('inp-amount').value='1';
  document.getElementById('inp-reason').value='';
  document.getElementById('inp-esMulta').checked=true;
  document.getElementById('esMulta-label').textContent='Es una multa ‚Äî duplica si no se paga';
  document.getElementById('fine-ov').classList.add('on');
}
function closeFineModal(){document.getElementById('fine-ov').classList.remove('on');}
document.getElementById('fine-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closeFineModal();});

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
function openPin(){pinBuf='';updDots();document.getElementById('pin-err').textContent='';document.getElementById('pin-ov').classList.add('on');}
function closePin(){document.getElementById('pin-ov').classList.remove('on');pendingAction=null;}
function updDots(){for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('on',i<pinBuf.length);}
function pinPress(v){
  if(v==='del'){pinBuf=pinBuf.slice(0,-1);updDots();return;}
  if(pinBuf.length>=4)return;
  pinBuf+=v;updDots();
  if(pinBuf.length===4){
    setTimeout(()=>{
      if(!ADMIN_PIN){document.getElementById('pin-err').textContent='PIN cargando, espera';pinBuf='';updDots();return;}
      if(pinBuf===ADMIN_PIN){
        isAdmin=true;closePin();updUI();
        if(pendingAction==='fine'){pendingAction=null;openFineModal();}
      }else{
        document.getElementById('pin-err').textContent='PIN incorrecto';pinBuf='';updDots();
      }
    },150);
  }
}
function updUI(){document.getElementById('admin-badge').classList.toggle('on',isAdmin);render();}
function goPage(n,btn){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+n).classList.add('on');
  btn.classList.add('on');
}

/* ‚îÄ‚îÄ Build PIN grid ‚îÄ‚îÄ */
[1,2,3,4,5,6,7,8,9,'del',0,'ok'].forEach(k=>{
  if(k==='ok'){document.getElementById('pin-grid').appendChild(document.createElement('div'));return;}
  const b=document.createElement('button');
  b.className='pk'+(k==='del'?' del':'');
  b.textContent=k==='del'?'‚å´':String(k);
  b.onclick=()=>pinPress(String(k));
  document.getElementById('pin-grid').appendChild(b);
});

/* ‚îÄ‚îÄ Config ‚îÄ‚îÄ */
async function loadConfig(){
  try{const r=await getConfig();if(r?.length)ADMIN_PIN=r[0].value;}
  catch(e){console.warn('Config:',e);}
}

/* ‚îÄ‚îÄ logo onerror handler ‚îÄ‚îÄ */
document.querySelector('.logo img').addEventListener('load',()=>{
  document.getElementById('logo-fallback').style.display='none';
});

/* ‚îÄ‚îÄ PWA ‚îÄ‚îÄ */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}

loadConfig();
render();
setInterval(render,30000);
</script>
</body>
</html>
