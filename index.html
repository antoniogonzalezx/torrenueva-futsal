<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Torrenueva">
<meta name="theme-color" content="#080808">
<title>Torrenueva Futsal</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<!-- Favicon bal√≥n de f√∫tbol -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='85'>‚öΩ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,200;0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,700;1,9..40,900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:   #080808;
  --bg1:  #0f0f0f;
  --bg2:  #161616;
  --bg3:  #202020;
  --bor:  #242424;
  --txt:  #f0f0f0;
  --sub:  #6a6a6a;
  --sub2: #333;
  --yel:  #f2c12e;   /* amarillo equipaci√≥n */
  --grn:  #3fc46a;   /* verde equipaci√≥n */
  --red:  #e05252;
  --ora:  #d98830;
  --yel-d: rgba(242,193,46,.13);
  --grn-d: rgba(63,196,106,.12);
  --red-d: rgba(224,82,82,.12);
  --safe: env(safe-area-inset-bottom, 0px);
  --r:    20px;
  --r2:   13px;

  /* Paleta de fondos para tarjetas ‚Äî colores saturados oscuros */
  --card-a: #12172b;  /* azul √≠ndigo */
  --card-b: #0e1f13;  /* verde bosque */
  --card-c: #1f100a;  /* naranja carb√≥n */
  --card-d: #1a0e22;  /* violeta */
  --card-e: #0a1a1a;  /* teal profundo */
  --card-f: #1f1808;  /* √°mbar oscuro */
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;overscroll-behavior:none}
body{
  font-family:'DM Sans',system-ui,sans-serif;
  background:var(--bg);color:var(--txt);
  min-height:100dvh;
  padding-bottom:calc(88px + var(--safe));
  -webkit-font-smoothing:antialiased;
}
button{font-family:inherit;cursor:pointer}
input,select{font-family:inherit}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.hdr{
  position:sticky;top:0;z-index:90;
  background:rgba(8,8,8,.9);
  backdrop-filter:blur(32px) saturate(1.8);
  -webkit-backdrop-filter:blur(32px) saturate(1.8);
  border-bottom:1px solid var(--bor);
  padding:11px 18px;
  padding-top:max(11px, env(safe-area-inset-top,11px));
  display:flex;align-items:center;gap:11px;
}
.logo{
  width:34px;height:34px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:1.55rem;line-height:1;
}
.logo img{width:34px;height:34px;border-radius:9px;object-fit:cover}
.hdr-brand{flex:1;min-width:0}
.brand-line{
  font-size:.98rem;line-height:1;letter-spacing:-.3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
/* TORRENUEVA ‚Äî amarillo, negrita, cursiva */
.brand-line .b1{color:var(--yel);font-weight:900;font-style:normal}
/* FUTSAL ‚Äî verde, fina, recta */
.brand-line .b2{color:var(--grn);font-weight:200;font-style:normal;letter-spacing:.5px}
.brand-sub{
  font-family:'DM Mono',monospace;font-size:.54rem;
  color:var(--sub);margin-top:3px;letter-spacing:.5px;
}
.admin-badge{
  display:none;background:var(--yel-d);border:1px solid rgba(242,193,46,.3);
  border-radius:20px;padding:5px 11px;font-size:.67rem;font-weight:600;
  color:var(--yel);flex-shrink:0;align-items:center;gap:5px;cursor:pointer;
}
.admin-badge.on{display:flex}
.admin-badge .x{opacity:.45}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.hero{
  margin:12px;border-radius:var(--r);
  background:linear-gradient(145deg,#131313 0%,#0c0c0c 100%);
  padding:22px 22px 17px;position:relative;overflow:hidden;
  box-shadow:0 8px 40px rgba(0,0,0,.55);
}
.hero::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:
    radial-gradient(ellipse at 85% -5%, rgba(242,193,46,.08) 0%,transparent 55%),
    radial-gradient(ellipse at 5% 105%, rgba(63,196,106,.06) 0%,transparent 50%);
}
.hero-lbl{font-family:'DM Mono',monospace;font-size:.57rem;color:var(--sub);text-transform:uppercase;letter-spacing:2.5px}
.hero-amt{font-size:3.2rem;font-weight:900;letter-spacing:-3px;color:#fff;line-height:1;margin:5px 0 3px;font-style:italic}
.hero-amt .eur{color:var(--yel);font-style:normal;font-weight:300;font-size:2.2rem;vertical-align:baseline}
.hero-cnt{font-family:'DM Mono',monospace;font-size:.63rem;color:var(--sub)}
.pills{display:flex;gap:6px;margin-top:13px;flex-wrap:wrap}
.pill{
  background:rgba(255,255,255,.05);border-radius:20px;
  padding:4px 11px;font-size:.64rem;font-weight:500;color:var(--sub);
  display:flex;align-items:center;gap:4px;
}
.pill b{color:var(--txt);font-weight:600}
.pill.g{background:var(--grn-d);color:var(--grn)}
.pill.g b{color:var(--grn)}
.pill.y{background:var(--yel-d);color:var(--yel)}
.pill.y b{color:var(--yel)}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.sec{
  font-family:'DM Mono',monospace;font-size:.57rem;color:var(--sub2);
  text-transform:uppercase;letter-spacing:2px;
  padding:0 16px;margin:18px 0 10px;
  display:flex;align-items:center;gap:10px;
}
.sec::after{content:'';flex:1;height:1px;background:var(--bor)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER CARDS  ‚Äî tarjetas coloreadas
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.cards-wrap{padding:0 12px}

/* Paleta rotativa */
.pc.pa{background:linear-gradient(145deg,#14192e,#0e1325)}
.pc.pb{background:linear-gradient(145deg,#0f2016,#091710)}
.pc.pc_{background:linear-gradient(145deg,#22110a,#180d06)}
.pc.pd{background:linear-gradient(145deg,#1c0e25,#13091a)}
.pc.pe{background:linear-gradient(145deg,#091e1e,#051414)}
.pc.pf{background:linear-gradient(145deg,#201a08,#161204)}

.pc{
  border-radius:var(--r);overflow:hidden;margin-bottom:14px;
  box-shadow:0 10px 40px rgba(0,0,0,.5),0 2px 8px rgba(0,0,0,.35);
  transition:transform .15s;
}
.pc:active{transform:scale(.98)}

/* borde superior seg√∫n urgencia */
.pc .pc-bar{height:3px;width:100%}
.pc .pc-bar.ok {background:linear-gradient(90deg,var(--grn),transparent)}
.pc .pc-bar.w2 {background:linear-gradient(90deg,var(--ora),transparent)}
.pc .pc-bar.w4 {background:linear-gradient(90deg,var(--red),transparent)}

/* header de tarjeta */
.pc-hdr{
  display:flex;align-items:center;gap:14px;
  padding:15px 15px 11px;
}
.pc-em{font-size:2.1rem;line-height:1;flex-shrink:0;filter:drop-shadow(0 3px 10px rgba(0,0,0,.6))}
.pc-info{flex:1;min-width:0}
.pc-name{
  font-size:1.05rem;font-weight:800;letter-spacing:-.4px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;
}
.pc-meta{
  font-family:'DM Mono',monospace;font-size:.57rem;
  color:rgba(255,255,255,.38);margin-top:3px;
  display:flex;align-items:center;gap:8px;
}
.pc-meta .lv{color:var(--grn)}
.pc-tot{
  font-size:1.6rem;font-weight:900;letter-spacing:-1.5px;
  font-style:italic;color:#fff;flex-shrink:0;
}
.pc-tot.or{color:var(--ora)}
.pc-tot.rd{color:var(--red)}

/* grid 2 cols multas */
.pc-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:7px;padding:0 10px 12px;
}

/* tarjeta multa peque√±a */
.fc{
  background:rgba(0,0,0,.28);
  border-radius:var(--r2);padding:10px 11px;
  display:flex;flex-direction:column;gap:3px;
  position:relative;overflow:hidden;
}
.fc::after{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:1px;
}
.fc.f1::after{background:rgba(255,255,255,.06)}
.fc.f2::after{background:var(--ora)}
.fc.f4::after{background:var(--red)}
.fc-amt{font-size:1.3rem;font-weight:800;letter-spacing:-1px;line-height:1;color:#fff}
.fc-amt.or{color:var(--ora)}
.fc-amt.rd{color:var(--red)}
.fc-rsn{
  font-size:.7rem;color:rgba(255,255,255,.48);
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
  overflow:hidden;line-height:1.35;
}
.fc-meta2{
  font-family:'DM Mono',monospace;font-size:.55rem;
  color:rgba(255,255,255,.28);
  display:flex;align-items:center;justify-content:space-between;margin-top:2px;
}
.bdg{font-size:.5rem;padding:1px 4px;border-radius:4px;font-weight:700;letter-spacing:.3px;font-family:'DM Mono',monospace}
.bdg.x2{background:rgba(217,136,48,.15);color:var(--ora)}
.bdg.x4{background:rgba(224,82,82,.15);color:var(--red)}
.fc-btns{display:flex;gap:4px;margin-top:5px}
.pbtn{
  flex:1;background:rgba(242,193,46,.1);border:1px solid rgba(242,193,46,.3);
  color:var(--yel);border-radius:8px;padding:5px 0;
  font-size:.62rem;font-weight:600;transition:all .15s;
}
.pbtn:active{background:var(--yel);color:#000;border-color:var(--yel)}
.dbtn{
  background:transparent;border:1px solid rgba(255,255,255,.1);
  color:rgba(255,255,255,.3);border-radius:8px;padding:5px 8px;font-size:.7rem;transition:all .15s;
}
.dbtn:active{border-color:var(--red);color:var(--red)}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TABBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.nav-wrap{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:8px 16px;
  padding-bottom:max(10px,calc(var(--safe) + 4px));
  pointer-events:none;
}
.bnav{
  display:flex;flex:1;max-width:380px;
  background:rgba(18,18,18,.78);
  backdrop-filter:blur(48px) saturate(200%) brightness(1.1);
  -webkit-backdrop-filter:blur(48px) saturate(200%) brightness(1.1);
  border:1px solid rgba(255,255,255,.07);border-radius:100px;padding:5px;
  box-shadow:0 8px 32px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);
  pointer-events:all;
}
.ni{
  flex:1;display:flex;flex-direction:column;align-items:center;
  gap:2px;background:transparent;border:none;color:var(--sub2);
  padding:5px 2px;border-radius:100px;transition:color .2s;
}
.ni .ic{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;transition:transform .2s,background .2s}
.ni .lb{font-size:.49rem;font-weight:600;letter-spacing:.1px;transition:color .2s}
.ni.on{color:var(--yel)}
.ni.on .ic{background:var(--yel-d);transform:scale(1.06)}
.ni.on .lb{color:var(--yel)}
.ni:active .ic{transform:scale(.87)}
.fab{
  width:52px;height:52px;border-radius:50%;border:none;
  background:var(--yel);color:#000;font-size:1.5rem;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 24px rgba(242,193,46,.4),0 2px 8px rgba(0,0,0,.4);
  pointer-events:all;flex-shrink:0;transition:transform .12s;
}
.fab:active{transform:scale(.88)}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.pg{display:none;animation:pgIn .18s ease}
.pg.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.rksec{margin:0 12px 12px}
.rkhead{
  background:var(--bg2);border-radius:var(--r) var(--r) 0 0;
  padding:10px 16px;font-family:'DM Mono',monospace;font-size:.57rem;
  color:var(--sub);text-transform:uppercase;letter-spacing:1.5px;
  display:flex;align-items:center;gap:6px;
}
.rkhead .dot{width:5px;height:5px;border-radius:50%;background:var(--yel);flex-shrink:0}
.rklist{
  background:var(--bg1);border-radius:0 0 var(--r) var(--r);overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.rkrow{display:flex;align-items:center;gap:11px;padding:11px 16px;border-bottom:1px solid var(--bor)}
.rkrow:last-child{border-bottom:none}
.rkpos{font-family:'DM Mono',monospace;font-size:.7rem;width:16px;text-align:center;flex-shrink:0;color:var(--sub2)}
.rkpos.g{color:var(--yel)}.rkpos.s{color:#555}.rkpos.b{color:#3d2a0a}
.rkem{font-size:1.1rem;flex-shrink:0}
.rknm{flex:1;font-weight:600;font-size:.85rem}
.rkam{font-family:'DM Mono',monospace;font-size:.93rem;font-weight:500;color:var(--red)}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:6px;padding:0 12px}
.cc{background:var(--bg1);border-radius:var(--r2);padding:10px 5px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,.25)}
.cc-em{font-size:1.4rem}
.cc-nm{font-family:'DM Mono',monospace;font-size:.57rem;font-weight:500;color:var(--grn);margin-top:5px}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VIDAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.lc-wrap{padding:0 12px}
.lc{
  background:var(--bg1);border-radius:var(--r);
  display:flex;align-items:center;gap:13px;padding:13px 15px;margin-bottom:7px;
  box-shadow:0 4px 16px rgba(0,0,0,.28);
}
.lc-em{font-size:1.55rem;flex-shrink:0}
.lc-nm{flex:1;font-weight:600;font-size:.88rem}
.lc-eu{font-family:'DM Mono',monospace;font-size:.98rem;font-weight:500;color:var(--grn)}
.lc-z {font-family:'DM Mono',monospace;font-size:.7rem;color:var(--sub2)}
.log-box{margin:0 12px;background:var(--bg1);border-radius:var(--r);overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.25)}
.log-r{display:flex;align-items:center;gap:10px;padding:10px 13px;border-bottom:1px solid var(--bor)}
.log-r:last-child{border-bottom:none}
.log-d{font-family:'DM Mono',monospace;font-size:.86rem;font-weight:600;flex-shrink:0;width:52px;text-align:right}
.log-d.p{color:var(--grn)}.log-d.n{color:var(--red)}
.log-i{flex:1;min-width:0}
.log-nm{font-weight:600;font-size:.8rem}
.log-rs{font-size:.67rem;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.log-dt{font-family:'DM Mono',monospace;font-size:.57rem;color:var(--sub2);flex-shrink:0}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ HUCHA / PAGOS EXTRA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.pay-wrap{padding:0 12px}
.pay-total{
  background:linear-gradient(135deg,#0a1f10,#06170c);
  border-radius:var(--r);padding:16px 17px;margin-bottom:12px;
  box-shadow:0 6px 24px rgba(0,0,0,.35);
  display:flex;align-items:center;gap:14px;
}
.pay-total .pt-em{font-size:2rem}
.pay-total .pt-lbl{font-family:'DM Mono',monospace;font-size:.56rem;color:var(--grn);text-transform:uppercase;letter-spacing:2px;margin-bottom:3px}
.pay-total .pt-amt{font-size:1.6rem;font-weight:900;letter-spacing:-1.5px;color:var(--grn);font-style:italic}
.pay-item{
  background:var(--bg1);border-radius:var(--r2);
  display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:6px;
  box-shadow:0 2px 10px rgba(0,0,0,.22);
}
.pay-em{font-size:1.3rem;flex-shrink:0}
.pay-info{flex:1;min-width:0}
.pay-nm{font-weight:600;font-size:.84rem}
.pay-nt{font-size:.68rem;color:var(--sub);margin-top:1px}
.pay-am{font-family:'DM Mono',monospace;font-size:1rem;font-weight:600;color:var(--grn);flex-shrink:0}
.pay-del{background:transparent;border:none;color:var(--sub2);font-size:.8rem;padding:4px;flex-shrink:0}
.pay-del:active{color:var(--red)}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EQUIPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.kit-wrap{margin:0 12px;border-radius:var(--r);overflow:hidden;display:flex;background:var(--bg1);box-shadow:0 4px 16px rgba(0,0,0,.28)}
.kit-img{width:88px;height:108px;object-fit:cover;flex-shrink:0}
.kit-info{padding:13px;flex:1}
.kit-info h3{font-family:'DM Mono',monospace;font-size:.56rem;color:var(--yel);text-transform:uppercase;letter-spacing:2px;margin-bottom:7px}
.kit-rule{font-size:.73rem;color:var(--sub);line-height:1.8}
.kit-rule b{color:var(--txt)}
.rules-box{margin:0 12px;background:var(--bg1);border-radius:var(--r);overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.22)}
.rule{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;border-bottom:1px solid var(--bor)}
.rule:last-child{border-bottom:none}
.rule-nm{font-size:.81rem;font-weight:500}
.rule-vl{font-family:'DM Mono',monospace;font-size:.81rem;color:var(--yel)}
.rule-nt{font-family:'DM Mono',monospace;font-size:.63rem;color:var(--sub2)}
.pl-box{margin:0 12px;background:var(--bg1);border-radius:var(--r);overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.22)}
.pl-r{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--bor)}
.pl-r:last-child{border-bottom:none}
.pl-em{font-size:1.2rem;flex-shrink:0}
.pl-nm{flex:1;font-weight:500;font-size:.84rem}
.pl-lv{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--grn);margin-right:6px}
.pl-del{background:transparent;border:1px solid var(--bor);color:var(--sub);border-radius:6px;padding:3px 9px;font-size:.63rem;transition:all .15s}
.pl-del:active{border-color:var(--red);color:var(--red)}
.add-row{display:flex;gap:8px;margin:8px 12px}
.add-row input{flex:1;background:var(--bg1);border:1px solid var(--bor);border-radius:10px;color:var(--txt);padding:10px 12px;font-size:.83rem;outline:none;transition:border-color .15s}
.add-row input:focus{border-color:var(--yel)}
.add-row button{background:var(--yel);color:#000;border:none;border-radius:10px;padding:10px 15px;font-size:.79rem;font-weight:600;flex-shrink:0}
.ibox{margin:8px 12px;background:var(--bg1);border-radius:var(--r);padding:13px 15px;box-shadow:0 2px 10px rgba(0,0,0,.18)}
.ibox-lbl{font-family:'DM Mono',monospace;font-size:.54rem;color:var(--sub2);text-transform:uppercase;letter-spacing:2px;margin-bottom:5px}
.ibox-txt{font-size:.75rem;color:var(--sub);line-height:1.75}
.ibox-txt b{color:var(--txt)}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.ov{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.72);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);align-items:flex-end;justify-content:center}
.ov.on{display:flex}
.ov.ctr{align-items:center}
.sheet{
  width:100%;max-width:480px;
  background:var(--bg2);
  border-top-left-radius:26px;border-top-right-radius:26px;
  padding:10px 20px 24px;
  padding-bottom:max(28px,calc(var(--safe) + 20px));
  box-shadow:0 -8px 40px rgba(0,0,0,.5);
  animation:su .24s cubic-bezier(.16,1,.3,1);
}
.handle{width:36px;height:4px;background:var(--bg3);border-radius:2px;margin:10px auto 20px}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mbox{
  width:88%;max-width:300px;margin:auto;
  background:var(--bg2);border-radius:26px;
  padding:28px 22px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  animation:bi .18s ease;
}
@keyframes bi{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
.mtit{font-size:1rem;font-weight:700;margin-bottom:4px;letter-spacing:-.3px}
.msub{font-size:.71rem;color:var(--sub);margin-bottom:17px;font-family:'DM Mono',monospace}
.field{margin-bottom:10px}
.field label{display:block;font-family:'DM Mono',monospace;font-size:.56rem;color:var(--sub);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px}
.field select,.field input{
  width:100%;background:var(--bg);border:1px solid var(--bor);
  border-radius:12px;color:var(--txt);padding:11px 13px;
  font-size:.87rem;outline:none;transition:border-color .15s;-webkit-appearance:none;
}
.field select:focus,.field input:focus{border-color:var(--yel)}
.field select option{background:var(--bg2)}
.f-row{display:flex;gap:8px}
.f-row .field{flex:1}
.bok{width:100%;background:var(--yel);color:#000;border:none;border-radius:12px;padding:13px;font-size:.9rem;font-weight:700;margin-top:8px;letter-spacing:-.2px}
.bcan{width:100%;background:transparent;color:var(--sub);border:none;padding:10px;font-size:.79rem;margin-top:4px}
.lv-prev{background:var(--grn-d);border-radius:12px;padding:11px 13px;margin-bottom:12px;font-size:.75rem;color:var(--grn);line-height:1.6;display:none}
.lv-prev b{color:var(--grn)}

/* PIN */
.pin-tit{font-size:1rem;font-weight:700;margin-bottom:4px}
.pin-sub{font-family:'DM Mono',monospace;font-size:.64rem;color:var(--sub);margin-bottom:20px;letter-spacing:.5px}
.pin-dots{display:flex;justify-content:center;gap:12px;margin-bottom:22px}
.pin-dot{width:12px;height:12px;border-radius:50%;background:var(--bg3);transition:all .15s}
.pin-dot.on{background:var(--yel);box-shadow:0 0 12px rgba(242,193,46,.4)}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.pk{background:var(--bg3);border-radius:12px;border:none;padding:14px;font-family:'DM Mono',monospace;font-size:1.2rem;color:var(--txt);transition:all .12s;font-weight:500}
.pk:active{background:var(--yel);color:#000}
.pk.del{color:var(--sub);font-size:.86rem}
.pin-err{font-family:'DM Mono',monospace;font-size:.64rem;color:var(--red);margin-top:10px;height:14px;letter-spacing:.5px}
.pin-cancel{background:transparent;border:none;color:var(--sub);font-size:.73rem;margin-top:13px;width:100%}

/* Action picker */
.act-btn{
  width:100%;border:none;border-radius:14px;padding:14px;
  font-size:.9rem;font-weight:700;margin-bottom:8px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.act-btn.red{background:var(--red-d);color:var(--red);border:1px solid rgba(224,82,82,.25)}
.act-btn.grn{background:var(--grn-d);color:var(--grn);border:1px solid rgba(63,196,106,.25)}

.empty{text-align:center;color:var(--sub);padding:50px 20px}
.empty-ic{font-size:2.5rem;margin-bottom:11px;opacity:.35}
.empty p{font-family:'DM Mono',monospace;font-size:.67rem;letter-spacing:.5px}
.loading{text-align:center;font-family:'DM Mono',monospace;font-size:.63rem;color:var(--sub2);padding:38px}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="logo">
    <!-- Si hay escudo propio lo muestra, sino el bal√≥n SVG -->
    <img src="escudo.png" alt="" onerror="this.style.display='none'">
    <span style="font-size:1.6rem;line-height:1">‚öΩ</span>
  </div>
  <div class="hdr-brand">
    <div class="brand-line">
      <span class="b1">TORRENUEVA</span><span class="b2">FUTSAL</span>
    </div>
    <div class="brand-sub">MULTAS ¬∑ T25/26</div>
  </div>
  <div class="admin-badge" id="admin-badge" onclick="logoutAdmin()">
    üîì Admin <span class="x">‚úï</span>
  </div>
</header>

<!-- HERO -->
<div class="hero">
  <div class="hero-lbl">Total pendiente</div>
  <div class="hero-amt" id="h-total">‚Äî<span class="eur"></span></div>
  <div class="hero-cnt" id="h-count">cargando...</div>
  <div class="pills" id="h-pills"></div>
</div>

<!-- MULTAS -->
<div class="pg on" id="pg-multas">
  <div class="sec">Pendientes</div>
  <div id="fines-list"><div class="loading">cargando...</div></div>
</div>

<!-- VIDAS -->
<div class="pg" id="pg-lives">
  <div class="sec">Saldo de vidas</div>
  <div class="lc-wrap" id="lives-list"></div>
  <div class="sec">Historial</div>
  <div class="log-box" id="log-list"><div class="loading">cargando...</div></div>
  <div style="height:10px"></div>
</div>

<!-- RANKING -->
<div class="pg" id="pg-ranking">
  <div class="sec">Temporada 2025/26</div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-season"></div>
  </div>
  <div class="sec">Este mes ¬∑ <span id="month-lbl" style="font-family:'DM Sans';font-size:.72rem;font-weight:600;color:var(--txt);text-transform:none;letter-spacing:0"></span></div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-month"></div>
  </div>
  <div class="rksec">
    <div class="rkhead"><div class="dot" style="background:var(--red)"></div>m√°s deuda</div>
    <div class="rklist" id="rk-debt"></div>
  </div>
  <div class="sec">Sin multas este mes</div>
  <div class="cgrid" id="clean-grid"></div>
  <div style="height:10px"></div>
</div>

<!-- HUCHA -->
<div class="pg" id="pg-hucha">
  <div class="sec">Pagos extra a la hucha</div>
  <div class="pay-wrap" id="payments-list"><div class="loading">cargando...</div></div>
  <div style="height:10px"></div>
</div>

<!-- EQUIPO -->
<div class="pg" id="pg-team">
  <div class="sec">Equipaci√≥n</div>
  <div class="kit-wrap">
    <img class="kit-img" src="equipacion.jpg" alt="" onerror="this.style.display='none'">
    <div class="kit-info">
      <h3>Kit oficial</h3>
      <div class="kit-rule"><b>Pantal√≥n</b> ‚Äî del club</div>
      <div class="kit-rule"><b>Medias</b> ‚Äî color oficial</div>
      <div class="kit-rule"><b>Camiseta</b> ‚Äî entregar limpia</div>
    </div>
  </div>
  <div class="sec">Jugadores</div>
  <div class="pl-box" id="player-list"></div>
  <div class="add-row" id="add-player-row" style="display:none">
    <input type="text" id="new-player-name" placeholder="Nombre del jugador">
    <button onclick="addPlayer()">+ A√±adir</button>
  </div>
  <div class="sec">Multas habituales</div>
  <div class="rules-box">
    <div class="rule"><span class="rule-nm">Llegar tarde</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Pantal√≥n equivocado</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">No avisar ausencia</span><span class="rule-vl">2‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 2 semanas</span><span class="rule-nt">√ó2 auto</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 4 semanas</span><span class="rule-nt">√ó4 auto</span></div>
  </div>
  <div class="sec">Sistema de vidas</div>
  <div class="ibox">
    <div class="ibox-lbl">¬øC√≥mo funciona?</div>
    <div class="ibox-txt">Cada <b>vida = 1‚Ç¨</b>. Si pagas de m√°s, el exceso se acumula como cr√©dito que se usa autom√°ticamente en la siguiente multa.<br><br>Los <b>pagos a la hucha</b> (üí∞) no son multas: no duplican ni afectan al ranking.</div>
  </div>
  <div class="sec">Instalar como app</div>
  <div class="ibox"><div class="ibox-lbl">iOS Safari</div><div class="ibox-txt"><b>Compartir</b> ‚Üí <b>A√±adir a pantalla de inicio</b></div></div>
  <div class="ibox"><div class="ibox-lbl">Android Chrome</div><div class="ibox-txt">Men√∫ <b>‚ãÆ</b> ‚Üí <b>Instalar app</b></div></div>
  <div style="height:10px"></div>
</div>

<!-- TABBAR -->
<div class="nav-wrap">
  <nav class="bnav">
    <button class="ni on" onclick="goPage('multas',this)"><div class="ic">üê∑</div><span class="lb">Multas</span></button>
    <button class="ni" onclick="goPage('lives',this)"><div class="ic">‚ù§Ô∏è</div><span class="lb">Vidas</span></button>
    <button class="ni" onclick="goPage('ranking',this)"><div class="ic">üèÜ</div><span class="lb">Ranking</span></button>
    <button class="ni" onclick="goPage('hucha',this)"><div class="ic">üí∞</div><span class="lb">Hucha</span></button>
    <button class="ni" onclick="goPage('team',this)"><div class="ic">‚öΩ</div><span class="lb">Equipo</span></button>
  </nav>
  <button class="fab" onclick="fabTap()">+</button>
</div>

<!-- PIN -->
<div class="ov ctr" id="pin-ov">
  <div class="mbox">
    <div class="pin-tit">Acceso admin</div>
    <div class="pin-sub">PIN del capit√°n</div>
    <div class="pin-dots">
      <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-grid" id="pin-grid"></div>
    <div class="pin-err" id="pin-err"></div>
    <button class="pin-cancel" onclick="closePin()">Cancelar</button>
  </div>
</div>

<!-- MODAL: ELEGIR ACCI√ìN -->
<div class="ov ctr" id="action-ov">
  <div class="mbox">
    <div class="mtit" style="margin-bottom:20px">¬øQu√© a√±adimos?</div>
    <button class="act-btn red" onclick="closeActionOv();openFineModal()">üê∑ &nbsp;Nueva multa</button>
    <button class="act-btn grn" onclick="closeActionOv();openHuchaModal()">üí∞ &nbsp;Pago a la hucha</button>
    <button class="bcan" onclick="closeActionOv()">Cancelar</button>
  </div>
</div>

<!-- MODAL: NUEVA MULTA -->
<div class="ov" id="fine-ov">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mtit">Nueva multa</div>
    <div style="height:14px"></div>
    <div class="field"><label>Jugador</label><select id="inp-player"><option value="">Seleccionar...</option></select></div>
    <div class="f-row">
      <div class="field"><label>Importe (‚Ç¨)</label><input type="number" id="inp-amount" min="1" step="1" placeholder="1"></div>
      <div class="field"><label>Fecha</label><input type="date" id="inp-date"></div>
    </div>
    <div class="field"><label>Motivo</label><input type="text" id="inp-reason" placeholder="ej: lleg√≥ tarde..."></div>
    <button class="bok" onclick="addFine()">A√±adir multa</button>
    <button class="bcan" onclick="closeFineModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL: PAGAR MULTA -->
<div class="ov ctr" id="pay-ov">
  <div class="mbox">
    <div class="mtit" id="pay-tit">Pagar multa</div>
    <div class="msub" id="pay-sub"></div>
    <div class="lv-prev" id="lv-prev"></div>
    <div class="field"><label>Importe pagado (‚Ç¨)</label><input type="number" id="pay-amt" min="0" step="1" placeholder="0"></div>
    <button class="bok" onclick="confirmPay()">Confirmar pago</button>
    <button class="bcan" onclick="closePayOv()">Cancelar</button>
  </div>
</div>

<!-- MODAL: HUCHA -->
<div class="ov" id="hucha-ov">
  <div class="sheet">
    <div class="handle"></div>
    <div class="mtit">Pago a la hucha</div>
    <div style="height:14px"></div>
    <div class="field"><label>Jugador</label><select id="hucha-player"><option value="">Seleccionar...</option></select></div>
    <div class="f-row">
      <div class="field"><label>Importe (‚Ç¨)</label><input type="number" id="hucha-amt" min="1" step="1" placeholder="1"></div>
      <div class="field"><label>Fecha</label><input type="date" id="hucha-date"></div>
    </div>
    <div class="field"><label>Nota (opcional)</label><input type="text" id="hucha-note" placeholder="ej: bizum recibido..."></div>
    <button class="bok" style="background:var(--grn)" onclick="addPayment()">Registrar pago</button>
    <button class="bcan" onclick="closeHuchaModal()">Cancelar</button>
  </div>
</div>

<script>
/* ================================================================ CONFIG */
const SUPA_URL     = 'https://cmfhosxslodnrxlpifrn.supabase.co';
const SUPA_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZmhvc3hzbG9kbnJ4bHBpZnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NDY2NTQsImV4cCI6MjA4NzIyMjY1NH0.c4-Zb79UQhshpzQH79gIoro3IBKEliEjBMlhjypa_dc';
const SEASON_START = new Date('2025-07-01');
const PALETA       = ['pa','pb','pc_','pd','pe','pf'];
/* ================================================================ */

let isAdmin=false, pinBuf='', pendingAction=null;
let players=[], currentPayFine=null, ADMIN_PIN=null;
window._cached_fines=[];

/* ‚îÄ‚îÄ Supabase ‚îÄ‚îÄ */
async function sb(path,opts={}){
  const method=opts.method||'GET';
  const isW=['POST','PATCH','PUT'].includes(method);
  const h={'apikey':SUPA_KEY,'Authorization':'Bearer '+SUPA_KEY};
  if(isW){h['Content-Type']='application/json';h['Prefer']='return=representation';}
  if(method==='DELETE') h['Prefer']='return=minimal';
  Object.assign(h,opts.headers||{});
  const r=await fetch(SUPA_URL+'/rest/v1/'+path,{...opts,headers:h});
  if(!r.ok){const m=await r.text().catch(()=>r.statusText);throw new Error(`${r.status}: ${m}`);}
  const t=await r.text();return t?JSON.parse(t):[];
}
const getConfig   = ()     => sb('config?select=value&key=eq.admin_pin');
const getPlayers  = ()     => sb('players?active=eq.true&select=id,name,lives,emoji&order=name.asc');
const getAll      = ()     => sb('multas?order=date.desc');
const getPayments = ()     => sb('payments?order=date.desc');
const getLivesLog = ()     => sb('lives_log?order=created_at.desc&limit=60');
const postFine    = d      => sb('multas',   {method:'POST',body:JSON.stringify(d)});
const postPayment = d      => sb('payments', {method:'POST',body:JSON.stringify(d)});
const patchFine   = (id,d) => sb(`multas?id=eq.${id}`,   {method:'PATCH',body:JSON.stringify(d)});
const deleteFine  = id     => sb(`multas?id=eq.${id}`,   {method:'DELETE'});
const deletePayment=id     => sb(`payments?id=eq.${id}`,  {method:'DELETE'});
const patchPlayer = (id,d) => sb(`players?id=eq.${id}`,  {method:'PATCH',body:JSON.stringify(d)});
const postPlayer  = name   => sb('players', {method:'POST',body:JSON.stringify({name})});
const postLivesLog= d      => sb('lives_log',{method:'POST',body:JSON.stringify(d)});

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const wk      = ds => (Date.now()-new Date(ds+'T12:00:00'))/6048e5;
const mult    = ds => {const w=wk(ds);return w>=4?4:w>=2?2:1;};
const eff     = f  => f.amount*mult(f.date);
const fmt     = n  => (n%1===0?n:n.toFixed(2))+'‚Ç¨';
const fmtD    = ds => new Date(ds+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'short'});
const fmtDL   = ds => new Date(ds).toLocaleDateString('es-ES',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
const isSeason= ds => new Date(ds+'T12:00:00')>=SEASON_START;
const isMonth = ds => {const d=new Date(ds+'T12:00:00'),n=new Date();return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();};
const monthName=()=> new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'});
const posCls  = i  => ['g','s','b'][i]||'';
const liveStr = n  => {if(!n||n<=0)return'';return'‚ù§Ô∏è'.repeat(Math.floor(n))+(n-Math.floor(n)>0?'ü©∂':'');};
const emoji   = name=>{const p=players.find(x=>x.name===name);return p?.emoji||'üë§';};
const plColor = idx => PALETA[idx%PALETA.length];
const plLives = name=>{const p=players.find(x=>x.name===name);return p?parseFloat(p.lives||0):0;};

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
async function render(){
  let all,pls,log,pays;
  try{
    [all,pls,log,pays]=await Promise.all([getAll(),getPlayers(),getLivesLog(),getPayments()]);
    players=pls; window._cached_fines=all;
  }catch(e){
    console.error(e);
    document.getElementById('h-count').textContent='Error de conexi√≥n';return;
  }
  const pend =all.filter(f=>!f.paid);
  const paid =all.filter(f=>f.paid);
  const multa_total=pend.reduce((s,f)=>s+eff(f),0);
  const hucha_total=pays.reduce((s,p)=>s+parseFloat(p.amount),0);
  const net   =Math.max(0,multa_total-hucha_total);
  const lv_tot=pls.reduce((s,p)=>s+parseFloat(p.lives||0),0);

  document.getElementById('h-total').innerHTML=fmt(net).replace('‚Ç¨','<span class="eur">‚Ç¨</span>');
  document.getElementById('h-count').textContent=pend.length+' multa'+(pend.length!==1?'s':'')+' pendiente'+(pend.length!==1?'s':'');
  document.getElementById('month-lbl').textContent=monthName();
  document.getElementById('h-pills').innerHTML=
    `<div class="pill"><b>${pend.filter(f=>isSeason(f.date)).length}</b> esta temporada</div>
     <div class="pill"><b>${paid.filter(f=>isMonth(f.paid_at||f.date)).length}</b> pagadas este mes</div>
     ${hucha_total>0?`<div class="pill y"><b>${fmt(hucha_total)}</b> en hucha</div>`:''}
     ${lv_tot>0?`<div class="pill g"><b>${fmt(lv_tot)}</b> en vidas</div>`:''}`;

  renderCards(pend,pls);
  renderLives(pls,log);
  renderRanking(all,paid,pls);
  renderPayments(pays);
  renderPlayers(pls);
  rebuildSelects(pls);
}

/* ‚îÄ‚îÄ TARJETAS ‚îÄ‚îÄ */
function renderCards(pend,pls){
  const el=document.getElementById('fines-list');
  if(!pend.length){el.innerHTML='<div class="empty"><div class="empty-ic">üéâ</div><p>sin multas pendientes</p></div>';return;}
  const groups={};
  pls.forEach(p=>{groups[p.name]=[];});
  pend.forEach(f=>{if(!groups[f.player])groups[f.player]=[];groups[f.player].push(f);});
  let idx=0;
  el.innerHTML='<div class="cards-wrap">'+
    Object.entries(groups).filter(([,ff])=>ff.length>0).map(([player,ff])=>{
      const sorted=[...ff].sort((a,b)=>new Date(b.date)-new Date(a.date));
      const tot=ff.reduce((s,f)=>s+eff(f),0);
      const lives=plLives(player);
      const mx=Math.max(...ff.map(f=>mult(f.date)));
      const bar=mx===4?'w4':mx===2?'w2':'ok';
      const totCls=mx===4?'rd':mx===2?'or':'';
      const col=plColor(idx++);
      const fH=sorted.map(f=>{
        const m=mult(f.date),e=eff(f);
        const ac=m===4?'rd':m===2?'or':'';
        const fc=m===4?'f4':m===2?'f2':'f1';
        const b=m===4?`<span class="bdg x4">√ó4</span>`:m===2?`<span class="bdg x2">√ó2</span>`:'';
        const btns=isAdmin?`<div class="fc-btns">
          <button class="pbtn" onclick="openPayOv('${f.id}')">‚úì Pagar</button>
          <button class="dbtn" onclick="delFineAct('${f.id}')">üóë</button></div>`:'';
        return`<div class="fc ${fc}">
          <div class="fc-amt ${ac}">${fmt(e)}</div>
          <div class="fc-rsn">${f.reason||'sin motivo'}</div>
          <div class="fc-meta2"><span>${fmtD(f.date)}</span>${b}</div>
          ${btns}</div>`;
      }).join('');
      return`<div class="pc ${col}">
        <div class="pc-bar ${bar}"></div>
        <div class="pc-hdr">
          <div class="pc-em">${emoji(player)}</div>
          <div class="pc-info">
            <div class="pc-name">${player}</div>
            <div class="pc-meta">
              <span>${ff.length} multa${ff.length!==1?'s':''}</span>
              ${lives>0?`<span class="lv">‚ù§Ô∏è ${fmt(lives)}</span>`:''}
            </div>
          </div>
          <div class="pc-tot ${totCls}">${fmt(tot)}</div>
        </div>
        <div class="pc-grid">${fH}</div>
      </div>`;
    }).join('')+
  '</div>';
}

/* ‚îÄ‚îÄ Vidas ‚îÄ‚îÄ */
function renderLives(pls,log){
  document.getElementById('lives-list').innerHTML=
    [...pls].sort((a,b)=>(b.lives||0)-(a.lives||0)).map(p=>{
      const lv=parseFloat(p.lives||0);
      return`<div class="lc">
        <div class="lc-em">${p.emoji||'üë§'}</div>
        <div class="lc-nm">${p.name}</div>
        ${lv>0?`<span style="margin-right:6px">${liveStr(lv)}</span><div class="lc-eu">${fmt(lv)}</div>`:`<span class="lc-z">sin vidas</span>`}
      </div>`;
    }).join('');
  const lel=document.getElementById('log-list');
  if(!log.length){lel.innerHTML='<div class="loading">sin movimientos a√∫n</div>';return;}
  lel.innerHTML=log.map(l=>`<div class="log-r">
    <div class="log-d ${l.delta>0?'p':'n'}">${l.delta>0?'+':''}${fmt(l.delta)}</div>
    <div class="log-i">
      <div class="log-nm">${emoji(l.player)} ${l.player}</div>
      <div class="log-rs">${l.reason||''}</div>
    </div>
    <div class="log-dt">${fmtDL(l.created_at)}</div>
  </div>`).join('');
}

/* ‚îÄ‚îÄ Ranking ‚îÄ‚îÄ */
function renderRanking(all,paid,pls){
  const sPaid=paid.filter(f=>isSeason(f.date));
  const sTot={};sPaid.forEach(f=>{sTot[f.player]=(sTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-season',sTot,true);
  const mPaid=paid.filter(f=>isMonth(f.paid_at||f.date));
  const mTot={};mPaid.forEach(f=>{mTot[f.player]=(mTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-month',mTot,true);
  const mPend=all.filter(f=>!f.paid&&isMonth(f.date));
  const dTot={};mPend.forEach(f=>{dTot[f.player]=(dTot[f.player]||0)+eff(f);});
  rkList('rk-debt',dTot,false);
  const dirty=new Set(mPend.map(f=>f.player));
  const clean=pls.filter(p=>!dirty.has(p.name));
  document.getElementById('clean-grid').innerHTML=clean.length
    ?clean.map(p=>`<div class="cc"><div class="cc-em">${p.emoji||'üë§'}</div><div class="cc-nm">${p.name.split(' ')[0]}</div></div>`).join('')
    :'<p style="color:var(--sub2);font-family:\'DM Mono\';font-size:.65rem;padding:2px 0">nadie limpio</p>';
}
function rkList(id,tots,desc){
  const el=document.getElementById(id);
  const s=Object.entries(tots).filter(([,v])=>v>0).sort((a,b)=>desc?b[1]-a[1]:a[1]-b[1]);
  if(!s.length){el.innerHTML='<div class="rkrow"><span style="font-family:\'DM Mono\';font-size:.63rem;color:var(--sub2)">sin datos a√∫n</span></div>';return;}
  el.innerHTML=s.map(([nm,tot],i)=>`<div class="rkrow">
    <span class="rkpos ${posCls(i)}">${i+1}</span>
    <span class="rkem">${emoji(nm)}</span>
    <span class="rknm">${nm}</span>
    <span class="rkam">${fmt(tot)}</span>
  </div>`).join('');
}

/* ‚îÄ‚îÄ Hucha ‚îÄ‚îÄ */
function renderPayments(pays){
  const el=document.getElementById('payments-list');
  const tot=pays.reduce((s,p)=>s+parseFloat(p.amount),0);
  if(!pays.length){
    el.innerHTML='<div class="empty"><div class="empty-ic">üí∞</div><p>sin pagos extra a√∫n</p></div>';return;
  }
  const del=id=>isAdmin?`<button class="pay-del" onclick="delPayAct('${id}')">üóë</button>`:'';
  el.innerHTML=
    `<div class="pay-total">
      <div class="pt-em">üí∞</div>
      <div><div class="pt-lbl">Total en hucha</div><div class="pt-amt">${fmt(tot)}</div></div>
    </div>`+
    pays.map(p=>`<div class="pay-item">
      <div class="pay-em">${emoji(p.player)}</div>
      <div class="pay-info">
        <div class="pay-nm">${p.player}</div>
        <div class="pay-nt">${p.note||fmtD(p.date)}</div>
      </div>
      <div class="pay-am">${fmt(parseFloat(p.amount))}</div>
      ${del(p.id)}
    </div>`).join('');
}

/* ‚îÄ‚îÄ Equipo ‚îÄ‚îÄ */
function renderPlayers(pls){
  document.getElementById('player-list').innerHTML=pls.map(p=>`
    <div class="pl-r">
      <span class="pl-em">${p.emoji||'üë§'}</span>
      <div class="pl-nm">${p.name}</div>
      ${parseFloat(p.lives||0)>0?`<span class="pl-lv">‚ù§Ô∏è ${fmt(parseFloat(p.lives))}</span>`:''}
      ${isAdmin?`<button class="pl-del" onclick="delPlayerAct('${p.id}')">Baja</button>`:''}
    </div>`).join('');
  document.getElementById('add-player-row').style.display=isAdmin?'flex':'none';
}
function rebuildSelects(pls){
  ['inp-player','hucha-player'].forEach(id=>{
    const sel=document.getElementById(id);
    const prev=sel.value;
    sel.innerHTML='<option value="">Seleccionar...</option>';
    pls.forEach(p=>{const o=document.createElement('option');o.value=p.name;o.textContent=(p.emoji||'üë§')+' '+p.name;sel.appendChild(o);});
    if(prev) sel.value=prev;
  });
}

/* ‚îÄ‚îÄ Pagar multa ‚îÄ‚îÄ */
function openPayOv(fineId){
  const f=(window._cached_fines||[]).find(x=>x.id===fineId);
  if(!f){alert('Recarga la p√°gina.');return;}
  currentPayFine=f;
  const e=eff(f),lives=plLives(f.player),ul=Math.min(lives,e),tp=Math.max(0,e-ul);
  document.getElementById('pay-tit').textContent=`Pagar ‚Äî ${f.player}`;
  document.getElementById('pay-sub').textContent=`Multa: ${fmt(e)}`;
  document.getElementById('pay-amt').value=tp;
  const prev=document.getElementById('lv-prev');
  if(lives>0){
    prev.style.display='block';
    prev.innerHTML=lives>=e?`‚ù§Ô∏è Cubre la multa entera. Pago real: <b>${fmt(tp)}</b>`:`‚ù§Ô∏è ${fmt(ul)} en vidas. Resto: <b>${fmt(tp)}</b>`;
  }else{prev.style.display='none';}
  document.getElementById('pay-ov').classList.add('on');
}
function closePayOv(){document.getElementById('pay-ov').classList.remove('on');currentPayFine=null;}
document.getElementById('pay-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closePayOv();});
document.getElementById('pay-amt').addEventListener('input',()=>{
  if(!currentPayFine)return;
  const f=currentPayFine,e=eff(f),lives=plLives(f.player);
  const pi=parseFloat(document.getElementById('pay-amt').value)||0;
  const ul=Math.min(lives,e),ti=pi+ul,ex=Math.max(0,ti-e);
  const prev=document.getElementById('lv-prev');
  if(lives>0||ex>0){
    prev.style.display='block';
    let m='';
    if(ul>0)m+=`‚ù§Ô∏è Usa ${fmt(ul)} en vidas. `;
    if(ex>0)m+=`<b>+${fmt(ex)} vidas nuevas</b> por exceso.`;
    if(!m)m='Sin vidas aplicadas.';
    prev.innerHTML=m;
  }
});
async function confirmPay(){
  if(!currentPayFine)return;
  const f=currentPayFine,e=eff(f),lives=plLives(f.player);
  const pi=parseFloat(document.getElementById('pay-amt').value)||0;
  const ul=Math.min(lives,e),ti=pi+ul,ex=Math.max(0,ti-e),nl=lives-ul+ex;
  const pl=players.find(p=>p.name===f.player);
  const today=new Date().toISOString().split('T')[0],pm=mult(f.date);
  try{
    await patchFine(f.id,{paid:true,paid_mult:pm,paid_at:today,paid_amount:ti});
    if(pl) await patchPlayer(pl.id,{lives:nl});
    const log=[];
    if(ul>0)log.push({player:f.player,player_id:pl?.id,delta:-ul,reason:`Vidas usadas: "${f.reason||'sin motivo'}" (${fmt(e)})`});
    if(ex>0)log.push({player:f.player,player_id:pl?.id,delta:ex,reason:`Exceso ‚Üí nuevas vidas (${fmt(ex)})`});
    for(const l of log)await postLivesLog(l);
    closePayOv();render();
  }catch(err){alert('Error: '+err.message);}
}

/* ‚îÄ‚îÄ Acciones ‚îÄ‚îÄ */
async function delFineAct(id){if(!confirm('¬øEliminar multa?'))return;await deleteFine(id);render();}
async function delPayAct(id){if(!confirm('¬øEliminar pago?'))return;await deletePayment(id);render();}
async function addFine(){
  const p=document.getElementById('inp-player').value;
  const a=parseFloat(document.getElementById('inp-amount').value);
  const d=document.getElementById('inp-date').value;
  const r=document.getElementById('inp-reason').value.trim();
  if(!p)return alert('Selecciona un jugador');
  if(!a||a<=0)return alert('Importe inv√°lido');
  if(!d)return alert('Selecciona fecha');
  try{await postFine({player:p,amount:a,date:d,reason:r});closeFineModal();render();}
  catch(e){alert('Error: '+e.message);}
}
async function addPayment(){
  const p=document.getElementById('hucha-player').value;
  const a=parseFloat(document.getElementById('hucha-amt').value);
  const d=document.getElementById('hucha-date').value;
  const n=document.getElementById('hucha-note').value.trim();
  if(!p)return alert('Selecciona un jugador');
  if(!a||a<=0)return alert('Importe inv√°lido');
  if(!d)return alert('Selecciona fecha');
  try{await postPayment({player:p,amount:a,date:d,note:n});closeHuchaModal();render();}
  catch(e){alert('Error: '+e.message);}
}
async function addPlayer(){
  const n=document.getElementById('new-player-name').value.trim();
  if(!n)return;
  try{await postPlayer(n);document.getElementById('new-player-name').value='';render();}
  catch(e){alert('Error: '+e.message);}
}
async function delPlayerAct(id){if(!confirm('¬øDar de baja?'))return;await patchPlayer(id,{active:false});render();}

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
function fabTap(){if(isAdmin){openActionOv();return;}pendingAction='action';openPin();}
function logoutAdmin(){isAdmin=false;updUI();}

/* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
function openActionOv() {document.getElementById('action-ov').classList.add('on');}
function closeActionOv(){document.getElementById('action-ov').classList.remove('on');}
document.getElementById('action-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closeActionOv();});
function openFineModal(){
  document.getElementById('inp-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('inp-amount').value='1';
  document.getElementById('inp-reason').value='';
  document.getElementById('fine-ov').classList.add('on');
}
function closeFineModal(){document.getElementById('fine-ov').classList.remove('on');}
document.getElementById('fine-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closeFineModal();});
function openHuchaModal(){
  document.getElementById('hucha-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('hucha-amt').value='';
  document.getElementById('hucha-note').value='';
  document.getElementById('hucha-ov').classList.add('on');
}
function closeHuchaModal(){document.getElementById('hucha-ov').classList.remove('on');}
document.getElementById('hucha-ov').addEventListener('click',e=>{if(e.target===e.currentTarget)closeHuchaModal();});

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
function openPin(){pinBuf='';updDots();document.getElementById('pin-err').textContent='';document.getElementById('pin-ov').classList.add('on');}
function closePin(){document.getElementById('pin-ov').classList.remove('on');pendingAction=null;}
function updDots(){for(let i=0;i<4;i++)document.getElementById('d'+i).classList.toggle('on',i<pinBuf.length);}
function pinPress(v){
  if(v==='del'){pinBuf=pinBuf.slice(0,-1);updDots();return;}
  if(pinBuf.length>=4)return;
  pinBuf+=v;updDots();
  if(pinBuf.length===4){
    setTimeout(()=>{
      if(!ADMIN_PIN){document.getElementById('pin-err').textContent='PIN cargando, espera';pinBuf='';updDots();return;}
      if(pinBuf===ADMIN_PIN){
        isAdmin=true;closePin();updUI();
        if(pendingAction==='action'){pendingAction=null;openActionOv();}
      }else{document.getElementById('pin-err').textContent='PIN incorrecto';pinBuf='';updDots();}
    },150);
  }
}
function updUI(){document.getElementById('admin-badge').classList.toggle('on',isAdmin);render();}
function goPage(n,btn){
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+n).classList.add('on');btn.classList.add('on');
}

/* ‚îÄ‚îÄ PIN grid ‚îÄ‚îÄ */
[1,2,3,4,5,6,7,8,9,'del',0,'ok'].forEach(k=>{
  if(k==='ok'){document.getElementById('pin-grid').appendChild(document.createElement('div'));return;}
  const b=document.createElement('button');
  b.className='pk'+(k==='del'?' del':'');
  b.textContent=k==='del'?'‚å´':k;
  b.onclick=()=>pinPress(String(k));
  document.getElementById('pin-grid').appendChild(b);
});

/* ‚îÄ‚îÄ Config ‚îÄ‚îÄ */
async function loadConfig(){
  try{const r=await getConfig();if(r?.length)ADMIN_PIN=r[0].value;}
  catch(e){console.warn('Config:',e);}
}

/* ‚îÄ‚îÄ PWA ‚îÄ‚îÄ */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{});});
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
loadConfig();render();setInterval(render,30000);
</script>
</body>
</html>
