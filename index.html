<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Multas FC">
<meta name="theme-color" content="#080808">
<title>Multas ¬∑ Torrenueva</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:    #080808;
  --bg1:   #0f0f0f;
  --bg2:   #161616;
  --bg3:   #1e1e1e;
  --bor:   #242424;
  --bor2:  #2e2e2e;
  --txt:   #f0f0f0;
  --sub:   #7a7a7a;
  --sub2:  #444;
  --acc:   #f0c040;
  --acc-d: rgba(240,192,64,.12);
  --red:   #e05555;
  --red-d: rgba(224,85,85,.1);
  --ora:   #d98830;
  --ora-d: rgba(217,136,48,.1);
  --grn:   #4caf7d;
  --grn-d: rgba(76,175,125,.1);
  --safe:  env(safe-area-inset-bottom, 0px);
  --r:     18px;
  --r2:    12px;
}
*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent }
html { height:100%; overscroll-behavior:none }
body {
  font-family:'DM Sans',system-ui,sans-serif;
  background:var(--bg); color:var(--txt);
  min-height:100dvh;
  padding-bottom:calc(88px + var(--safe));
  -webkit-font-smoothing:antialiased;
}
button { font-family:inherit; cursor:pointer }
input, select { font-family:inherit }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr {
  position:sticky; top:0; z-index:90;
  background:rgba(8,8,8,.88);
  backdrop-filter:blur(28px) saturate(1.8);
  -webkit-backdrop-filter:blur(28px) saturate(1.8);
  border-bottom:1px solid var(--bor);
  padding:14px 18px;
  padding-top:max(14px, env(safe-area-inset-top, 14px));
  display:flex; align-items:center; gap:12px;
}
.logo {
  width:36px; height:36px; border-radius:10px; overflow:hidden;
  flex-shrink:0; border:1px solid var(--bor2); background:var(--bg2);
  display:flex; align-items:center; justify-content:center; font-size:1.2rem;
}
.logo img { width:100%; height:100%; object-fit:cover; display:block }
.hdr-text { flex:1; min-width:0 }
.hdr-text h1 { font-size:.95rem; font-weight:600; letter-spacing:-.3px }
.hdr-text p  { font-family:'DM Mono',monospace; font-size:.6rem; color:var(--sub); margin-top:2px; letter-spacing:.4px }
.admin-badge {
  display:none; background:var(--acc-d); border:1px solid rgba(240,192,64,.35);
  border-radius:20px; padding:5px 12px; font-size:.68rem; font-weight:600;
  color:var(--acc); flex-shrink:0; align-items:center; gap:6px; cursor:pointer;
}
.admin-badge.on { display:flex }
.admin-badge .x { opacity:.5; font-size:.8rem }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero {
  margin:14px; border-radius:var(--r);
  background:linear-gradient(135deg, var(--bg2) 0%, #111 100%);
  border:1px solid var(--bor);
  padding:22px 22px 18px; position:relative; overflow:hidden;
}
.hero::before {
  content:''; position:absolute; inset:0;
  background:radial-gradient(ellipse at 80% -20%, rgba(240,192,64,.07) 0%, transparent 60%);
  pointer-events:none;
}
.hero-label  { font-family:'DM Mono',monospace; font-size:.6rem; color:var(--sub); text-transform:uppercase; letter-spacing:2.5px }
.hero-amount { font-size:3.2rem; font-weight:700; letter-spacing:-2.5px; color:var(--txt); line-height:1; margin:6px 0 4px; font-style:italic }
.hero-amount .eur { color:var(--acc); font-style:normal }
.hero-count  { font-family:'DM Mono',monospace; font-size:.65rem; color:var(--sub) }
.hero-pills  { display:flex; gap:6px; margin-top:14px; flex-wrap:wrap }
.pill {
  background:var(--bg3); border:1px solid var(--bor2); border-radius:20px;
  padding:4px 11px; font-size:.66rem; font-weight:500; color:var(--sub);
  display:flex; align-items:center; gap:4px; letter-spacing:-.1px;
}
.pill b { color:var(--txt); font-weight:600 }
.pill.grn { border-color:rgba(76,175,125,.3); background:var(--grn-d); color:var(--grn) }
.pill.grn b { color:var(--grn) }

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.sec {
  font-family:'DM Mono',monospace; font-size:.6rem; color:var(--sub2);
  text-transform:uppercase; letter-spacing:2px;
  padding:0 16px; margin:18px 0 10px;
  display:flex; align-items:center; gap:10px;
}
.sec::after { content:''; flex:1; height:1px; background:var(--bor) }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYER CARDS ‚Äî nueva estructura
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.cards-wrap { padding:0 14px }

/* Tarjeta grande por jugador */
.player-card {
  background:var(--bg1);
  border:1px solid var(--bor);
  border-radius:var(--r);
  overflow:hidden;
  margin-bottom:12px;
  transition:border-color .2s;
}
.player-card.has-dupe { border-color:rgba(217,136,48,.35) }
.player-card.all-dupe { border-color:rgba(224,85,85,.35) }

/* Header de la tarjeta */
.pc-header {
  display:flex; align-items:center; gap:14px;
  padding:16px 16px 14px;
  border-bottom:1px solid var(--bor);
}
.pc-emoji {
  font-size:1.8rem; line-height:1; flex-shrink:0;
  filter:drop-shadow(0 2px 6px rgba(0,0,0,.4));
}
.pc-name-wrap { flex:1; min-width:0 }
.pc-name {
  font-size:1.05rem; font-weight:700; letter-spacing:-.4px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.pc-subtitle {
  font-family:'DM Mono',monospace; font-size:.58rem;
  color:var(--sub); margin-top:2px;
  display:flex; align-items:center; gap:6px;
}
.pc-right { display:flex; flex-direction:column; align-items:flex-end; gap:3px; flex-shrink:0 }
.pc-total {
  font-size:1.5rem; font-weight:700; letter-spacing:-1.5px;
  font-style:italic;
}
.pc-total.rd { color:var(--red) }
.pc-total.or { color:var(--ora) }
.pc-lives {
  font-family:'DM Mono',monospace; font-size:.62rem; color:var(--grn);
  display:flex; align-items:center; gap:3px;
}

/* Grid 2 columnas de multas peque√±as */
.pc-fines-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:8px; padding:12px;
}

/* Tarjeta peque√±a de multa */
.fc {
  background:var(--bg2);
  border:1px solid var(--bor2);
  border-radius:var(--r2);
  padding:10px 11px;
  display:flex; flex-direction:column; gap:4px;
  position:relative; overflow:hidden;
}
.fc::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
}
.fc.x1::before { background:transparent }
.fc.x2::before { background:var(--ora) }
.fc.x4::before { background:var(--red) }

.fc-amount {
  font-size:1.25rem; font-weight:700; letter-spacing:-1px; line-height:1;
}
.fc-amount.or { color:var(--ora) }
.fc-amount.rd { color:var(--red) }
.fc-reason {
  font-size:.72rem; font-weight:500; color:var(--sub);
  overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  line-height:1.35;
}
.fc-meta {
  font-family:'DM Mono',monospace; font-size:.57rem; color:var(--sub2);
  display:flex; align-items:center; justify-content:space-between; margin-top:2px;
}
.fc-badge {
  font-size:.5rem; padding:1px 4px; border-radius:4px; font-weight:700;
  letter-spacing:.3px; font-family:'DM Mono',monospace;
}
.fc-badge.x2 { background:var(--ora-d); color:var(--ora); border:1px solid rgba(217,136,48,.3) }
.fc-badge.x4 { background:var(--red-d); color:var(--red); border:1px solid rgba(224,85,85,.3) }
.fc-actions { display:flex; gap:4px; margin-top:4px }
.pbtn {
  flex:1; border:1px solid rgba(240,192,64,.4); background:transparent; color:var(--acc);
  border-radius:7px; padding:4px 0; font-size:.6rem; font-weight:600; transition:all .15s;
  font-family:'DM Sans',sans-serif;
}
.pbtn:active { background:var(--acc); color:#000 }
.dbtn {
  border:1px solid var(--bor2); background:transparent; color:var(--sub);
  border-radius:7px; padding:4px 7px; font-size:.7rem; transition:all .15s;
}
.dbtn:active { border-color:var(--red); color:var(--red) }

/* ‚îÄ‚îÄ TABBAR iOS 26 ‚îÄ‚îÄ */
.nav-wrap {
  position:fixed; bottom:0; left:0; right:0; z-index:100;
  display:flex; align-items:center; justify-content:center; gap:10px;
  padding:8px 18px;
  padding-bottom:max(10px, calc(var(--safe) + 4px));
  pointer-events:none;
}
.bnav {
  display:flex; flex:1; max-width:360px;
  background:rgba(22,22,22,.75);
  backdrop-filter:blur(48px) saturate(200%) brightness(1.1);
  -webkit-backdrop-filter:blur(48px) saturate(200%) brightness(1.1);
  border:1px solid rgba(255,255,255,.08); border-radius:100px; padding:5px;
  box-shadow:0 8px 32px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06);
  pointer-events:all;
}
.ni {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:2px; background:transparent; border:none; color:var(--sub2);
  padding:6px 4px; border-radius:100px; transition:color .2s;
}
.ni .ic  { width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; transition:transform .2s, background .2s }
.ni .lbl { font-size:.52rem; font-weight:600; letter-spacing:.1px; transition:color .2s }
.ni.on { color:var(--acc) }
.ni.on .ic { background:var(--acc-d); transform:scale(1.06) }
.ni.on .lbl { color:var(--acc) }
.ni:active .ic { transform:scale(.87) }
.nav-fab {
  width:52px; height:52px; border-radius:50%; border:none;
  background:var(--acc); color:#000; font-size:1.5rem; line-height:1;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 24px rgba(240,192,64,.4), 0 2px 8px rgba(0,0,0,.4);
  pointer-events:all; flex-shrink:0; transition:transform .12s, box-shadow .2s;
}
.nav-fab:active { transform:scale(.88) }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.pg { display:none; animation:pgIn .18s ease }
.pg.on { display:block }
@keyframes pgIn { from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:translateY(0) } }

/* ‚îÄ‚îÄ RANKING ‚îÄ‚îÄ */
.rksec { margin:0 14px 12px }
.rkhead {
  background:var(--bg1); border:1px solid var(--bor);
  border-radius:var(--r) var(--r) 0 0;
  padding:10px 16px; font-family:'DM Mono',monospace; font-size:.6rem;
  color:var(--sub); text-transform:uppercase; letter-spacing:1.5px;
  display:flex; align-items:center; gap:6px;
}
.rkhead .dot { width:5px; height:5px; border-radius:50%; background:var(--acc); flex-shrink:0 }
.rklist { background:var(--bg1); border:1px solid var(--bor); border-top:none; border-radius:0 0 var(--r) var(--r); overflow:hidden }
.rkrow  { display:flex; align-items:center; gap:12px; padding:11px 16px; border-bottom:1px solid var(--bor) }
.rkrow:last-child { border-bottom:none }
.rkpos  { font-family:'DM Mono',monospace; font-size:.72rem; width:18px; text-align:center; flex-shrink:0; color:var(--sub2) }
.rkpos.g { color:var(--acc) } .rkpos.s { color:#6a6a6a } .rkpos.b { color:#5a4020 }
.rk-emoji { font-size:1.1rem; flex-shrink:0 }
.rkname { flex:1; font-weight:600; font-size:.86rem }
.rkamt  { font-family:'DM Mono',monospace; font-size:.95rem; font-weight:500; color:var(--red) }

.cgrid { display:grid; grid-template-columns:repeat(auto-fill, minmax(82px,1fr)); gap:6px; padding:0 14px }
.cc { background:var(--bg1); border:1px solid var(--bor); border-radius:var(--r2); padding:10px 6px; text-align:center }
.cc-emoji { font-size:1.3rem }
.cc-name { font-family:'DM Mono',monospace; font-size:.58rem; font-weight:500; color:var(--acc); margin-top:5px }

/* ‚îÄ‚îÄ LIVES TAB ‚îÄ‚îÄ */
.lives-cards-wrap { padding:0 14px }
.lives-card {
  background:var(--bg1); border:1px solid var(--bor); border-radius:var(--r);
  display:flex; align-items:center; gap:14px; padding:14px 16px; margin-bottom:8px;
}
.lives-emoji { font-size:1.6rem; flex-shrink:0 }
.lives-name  { flex:1; font-weight:600; font-size:.9rem }
.lives-euro  { font-family:'DM Mono',monospace; font-size:1rem; font-weight:500; color:var(--grn) }
.lives-zero  { font-family:'DM Mono',monospace; font-size:.72rem; color:var(--sub2) }
.log-list { margin:0 14px; background:var(--bg1); border:1px solid var(--bor); border-radius:var(--r); overflow:hidden }
.log-row { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--bor) }
.log-row:last-child { border-bottom:none }
.log-delta { font-family:'DM Mono',monospace; font-size:.88rem; font-weight:600; flex-shrink:0; width:52px; text-align:right }
.log-delta.pos { color:var(--grn) } .log-delta.neg { color:var(--red) }
.log-info { flex:1; min-width:0 }
.log-player { font-weight:600; font-size:.82rem }
.log-reason { font-size:.68rem; color:var(--sub); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:1px }
.log-date   { font-family:'DM Mono',monospace; font-size:.58rem; color:var(--sub2); flex-shrink:0 }

/* ‚îÄ‚îÄ TEAM TAB ‚îÄ‚îÄ */
.kit-wrap { margin:0 14px; border-radius:var(--r); overflow:hidden; border:1px solid var(--bor); display:flex; background:var(--bg1) }
.kit-img  { width:90px; height:110px; object-fit:cover; flex-shrink:0 }
.kit-info { padding:14px; flex:1 }
.kit-info h3 { font-family:'DM Mono',monospace; font-size:.58rem; color:var(--acc); text-transform:uppercase; letter-spacing:2px; margin-bottom:8px }
.kit-rule { font-size:.74rem; color:var(--sub); line-height:1.8 }
.kit-rule b { color:var(--txt) }
.rules-wrap { margin:0 14px; border-radius:var(--r); overflow:hidden; border:1px solid var(--bor) }
.rule { display:flex; justify-content:space-between; align-items:center; padding:11px 16px; border-bottom:1px solid var(--bor) }
.rule:last-child { border-bottom:none }
.rule-nm   { font-size:.82rem; font-weight:500 }
.rule-vl   { font-family:'DM Mono',monospace; font-size:.82rem; color:var(--acc) }
.rule-note { font-family:'DM Mono',monospace; font-size:.65rem; color:var(--sub2) }
.player-list { margin:0 14px; border-radius:var(--r); overflow:hidden; border:1px solid var(--bor) }
.pl-row { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--bor) }
.pl-row:last-child { border-bottom:none }
.pl-emoji { font-size:1.2rem; flex-shrink:0 }
.pl-name  { flex:1; font-weight:500; font-size:.86rem }
.pl-lives-badge { font-family:'DM Mono',monospace; font-size:.7rem; color:var(--grn); margin-right:6px }
.pl-del   { background:transparent; border:1px solid var(--bor2); color:var(--sub); border-radius:6px; padding:3px 9px; font-size:.65rem; transition:all .15s }
.pl-del:active { border-color:var(--red); color:var(--red) }
.add-player-row { display:flex; gap:8px; margin:8px 14px }
.add-player-row input { flex:1; background:var(--bg1); border:1px solid var(--bor2); border-radius:10px; color:var(--txt); padding:10px 13px; font-size:.84rem; outline:none; transition:border-color .15s }
.add-player-row input:focus { border-color:var(--acc) }
.add-player-row button { background:var(--acc); color:#000; border:none; border-radius:10px; padding:10px 16px; font-size:.8rem; font-weight:600; flex-shrink:0 }
.infobox { margin:8px 14px; background:var(--bg1); border:1px solid var(--bor); border-radius:var(--r); padding:13px 15px }
.ib-lbl  { font-family:'DM Mono',monospace; font-size:.56rem; color:var(--sub2); text-transform:uppercase; letter-spacing:2px; margin-bottom:6px }
.ib-txt  { font-size:.76rem; color:var(--sub); line-height:1.75 }
.ib-txt b { color:var(--txt) }
.ib-txt code { background:var(--bg2); border:1px solid var(--bor2); border-radius:4px; padding:1px 5px; font-family:'DM Mono',monospace; font-size:.68rem; color:var(--acc); display:inline-block; margin:1px 0 }

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay { display:none; position:fixed; inset:0; z-index:200; background:rgba(0,0,0,.7); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); align-items:flex-end; justify-content:center }
.overlay.on { display:flex }
.overlay.center { align-items:center }
.sheet {
  width:100%; max-width:480px;
  background:var(--bg2); border:1px solid var(--bor2);
  border-top-left-radius:24px; border-top-right-radius:24px;
  padding:24px 20px;
  padding-bottom:max(32px, calc(var(--safe) + 22px));
  animation:sheetUp .24s cubic-bezier(.16,1,.3,1);
}
.sheet-handle {
  width:36px; height:4px; background:var(--bor2); border-radius:2px;
  margin:0 auto 20px; 
}
@keyframes sheetUp { from { transform:translateY(100%) } to { transform:translateY(0) } }
.mbox {
  width:88%; max-width:300px; margin:auto;
  background:var(--bg2); border:1px solid var(--bor2);
  border-radius:24px; padding:28px 22px; text-align:center;
  animation:boxIn .18s ease;
}
@keyframes boxIn { from { opacity:0; transform:scale(.93) } to { opacity:1; transform:scale(1) } }
.modal-title { font-size:1rem; font-weight:700; margin-bottom:4px; letter-spacing:-.3px }
.modal-sub   { font-size:.72rem; color:var(--sub); margin-bottom:18px; font-family:'DM Mono',monospace }
.field { margin-bottom:11px }
.field label { display:block; font-family:'DM Mono',monospace; font-size:.58rem; color:var(--sub); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:5px }
.field select, .field input {
  width:100%; background:var(--bg); border:1px solid var(--bor2);
  border-radius:11px; color:var(--txt); padding:11px 13px;
  font-size:.88rem; outline:none; transition:border-color .15s; -webkit-appearance:none;
}
.field select:focus, .field input:focus { border-color:var(--acc) }
.field select option { background:var(--bg2) }
.field-row { display:flex; gap:8px }
.field-row .field { flex:1 }
.btn-ok     { width:100%; background:var(--acc); color:#000; border:none; border-radius:12px; padding:13px; font-size:.9rem; font-weight:700; margin-top:8px; letter-spacing:-.2px }
.btn-cancel { width:100%; background:transparent; color:var(--sub); border:none; padding:10px; font-size:.8rem; margin-top:4px }
.lives-preview {
  background:var(--grn-d); border:1px solid rgba(76,175,125,.25); border-radius:11px;
  padding:11px 13px; margin-bottom:12px; font-size:.76rem; color:var(--grn); line-height:1.6;
  display:none;
}
.lives-preview b { color:var(--grn) }

/* PIN */
.pin-title { font-size:1rem; font-weight:700; margin-bottom:4px }
.pin-sub   { font-family:'DM Mono',monospace; font-size:.65rem; color:var(--sub); margin-bottom:20px; letter-spacing:.5px }
.pin-dots  { display:flex; justify-content:center; gap:12px; margin-bottom:22px }
.pin-dot   { width:12px; height:12px; border-radius:50%; background:var(--bor2); transition:all .15s }
.pin-dot.on { background:var(--acc); box-shadow:0 0 12px rgba(240,192,64,.4) }
.pin-grid  { display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
.pk {
  background:var(--bg3); border:1px solid var(--bor2); border-radius:12px;
  padding:14px; font-family:'DM Mono',monospace; font-size:1.2rem;
  color:var(--txt); transition:all .12s; font-weight:500;
}
.pk:active { background:var(--acc); color:#000; border-color:var(--acc) }
.pk.del    { color:var(--sub); font-size:.88rem }
.pin-err   { font-family:'DM Mono',monospace; font-size:.65rem; color:var(--red); margin-top:10px; height:14px; letter-spacing:.5px }
.pin-cancel { background:transparent; border:none; color:var(--sub); font-size:.74rem; margin-top:14px; width:100% }

.empty { text-align:center; color:var(--sub); padding:52px 20px }
.empty-icon { font-size:2.5rem; margin-bottom:12px; opacity:.4 }
.empty p { font-family:'DM Mono',monospace; font-size:.68rem; letter-spacing:.5px }
.loading { text-align:center; font-family:'DM Mono',monospace; font-size:.64rem; color:var(--sub2); padding:40px }
</style>
</head>
<body>

<header class="hdr">
  <div class="logo">
    <img src="escudo.png" alt="" onerror="this.style.display='none'">‚öΩ
  </div>
  <div class="hdr-text">
    <h1>Torrenueva Futsal</h1>
    <p>MULTAS ¬∑ T25/26</p>
  </div>
  <div class="admin-badge" id="admin-badge" onclick="logoutAdmin()">
    üîì Admin <span class="x">‚úï</span>
  </div>
</header>

<div class="hero">
  <div class="hero-label">Total pendiente</div>
  <div class="hero-amount" id="h-total">‚Äî<span class="eur"></span></div>
  <div class="hero-count" id="h-count">cargando...</div>
  <div class="hero-pills" id="h-pills"></div>
</div>

<!-- MULTAS -->
<div class="pg on" id="pg-multas">
  <div class="sec">Pendientes</div>
  <div id="fines-list"><div class="loading">cargando...</div></div>
</div>

<!-- VIDAS -->
<div class="pg" id="pg-lives">
  <div class="sec">Saldo de vidas</div>
  <div class="lives-cards-wrap" id="lives-list"><div class="loading">cargando...</div></div>
  <div class="sec">Historial</div>
  <div class="log-list" id="lives-log-list"><div class="loading">cargando...</div></div>
  <div style="height:10px"></div>
</div>

<!-- RANKING -->
<div class="pg" id="pg-ranking">
  <div class="sec">Temporada 2025/26</div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-season"></div>
  </div>
  <div class="sec">Este mes ¬∑ <span id="month-lbl" style="font-family:'DM Sans',sans-serif;font-size:.72rem;font-weight:600;color:var(--txt);text-transform:none;letter-spacing:0"></span></div>
  <div class="rksec">
    <div class="rkhead"><div class="dot"></div>m√°s pagado</div>
    <div class="rklist" id="rk-month"></div>
  </div>
  <div class="rksec" style="margin-top:4px">
    <div class="rkhead"><div class="dot" style="background:var(--red)"></div>m√°s deuda pendiente</div>
    <div class="rklist" id="rk-debt"></div>
  </div>
  <div class="sec">Sin multas este mes</div>
  <div class="cgrid" id="clean-grid"></div>
  <div style="height:10px"></div>
</div>

<!-- EQUIPO -->
<div class="pg" id="pg-team">
  <div class="sec">Equipaci√≥n</div>
  <div class="kit-wrap">
    <img class="kit-img" src="equipacion.jpg" alt="" onerror="this.style.display='none'">
    <div class="kit-info">
      <h3>Kit oficial</h3>
      <div class="kit-rule"><b>Pantal√≥n</b> ‚Äî del club</div>
      <div class="kit-rule"><b>Medias</b> ‚Äî color oficial</div>
      <div class="kit-rule"><b>Camiseta</b> ‚Äî entregar limpia</div>
    </div>
  </div>

  <div class="sec">Jugadores</div>
  <div class="player-list" id="player-list"><div class="loading">cargando...</div></div>
  <div class="add-player-row" id="add-player-row" style="display:none">
    <input type="text" id="new-player-name" placeholder="Nombre del jugador">
    <button onclick="addPlayer()">+ A√±adir</button>
  </div>

  <div class="sec">Multas habituales</div>
  <div class="rules-wrap">
    <div class="rule"><span class="rule-nm">Llegar tarde</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Pantal√≥n equivocado</span><span class="rule-vl">1‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">No avisar ausencia</span><span class="rule-vl">2‚Ç¨</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 2 semanas</span><span class="rule-note">√ó2 auto</span></div>
    <div class="rule"><span class="rule-nm">Sin pagar 4 semanas</span><span class="rule-note">√ó4 auto</span></div>
  </div>

  <div class="sec">Sistema de vidas</div>
  <div class="infobox">
    <div class="ib-lbl">¬øC√≥mo funciona?</div>
    <div class="ib-txt">
      Cada <b>vida = 1‚Ç¨</b>. Si un jugador paga de m√°s al saldar una multa, el exceso se acumula como vidas.<br><br>
      Ejemplo: multa de 3‚Ç¨, paga 5‚Ç¨ ‚Üí se queda con <b>2 vidas</b>.<br><br>
      Al marcar una multa como pagada, las vidas se usan autom√°ticamente primero.
    </div>
  </div>

  <div class="sec">Instalar como app</div>
  <div class="infobox">
    <div class="ib-lbl">iOS Safari</div>
    <div class="ib-txt"><b>Compartir</b> ‚Üí <b>A√±adir a pantalla de inicio</b></div>
  </div>
  <div class="infobox">
    <div class="ib-lbl">Android Chrome</div>
    <div class="ib-txt">Men√∫ <b>‚ãÆ</b> ‚Üí <b>Instalar app</b></div>
  </div>
  <div style="height:10px"></div>
</div>

<!-- TABBAR -->
<div class="nav-wrap">
  <nav class="bnav">
    <button class="ni on" onclick="goPage('multas',this)">
      <div class="ic">üê∑</div><span class="lbl">Multas</span>
    </button>
    <button class="ni" onclick="goPage('lives',this)">
      <div class="ic">‚ù§Ô∏è</div><span class="lbl">Vidas</span>
    </button>
    <button class="ni" onclick="goPage('ranking',this)">
      <div class="ic">üèÜ</div><span class="lbl">Ranking</span>
    </button>
    <button class="ni" onclick="goPage('team',this)">
      <div class="ic">‚öΩ</div><span class="lbl">Equipo</span>
    </button>
  </nav>
  <button class="nav-fab" onclick="fabTap()">+</button>
</div>

<!-- MODAL: PIN -->
<div class="overlay center" id="pin-overlay">
  <div class="mbox">
    <div class="pin-title">Acceso admin</div>
    <div class="pin-sub">PIN del capit√°n</div>
    <div class="pin-dots">
      <div class="pin-dot" id="d0"></div><div class="pin-dot" id="d1"></div>
      <div class="pin-dot" id="d2"></div><div class="pin-dot" id="d3"></div>
    </div>
    <div class="pin-grid" id="pin-grid"></div>
    <div class="pin-err" id="pin-err"></div>
    <button class="pin-cancel" onclick="closePin()">Cancelar</button>
  </div>
</div>

<!-- MODAL: NUEVA MULTA -->
<div class="overlay" id="fine-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="modal-title">Nueva multa</div>
    <div style="height:14px"></div>
    <div class="field">
      <label>Jugador</label>
      <select id="inp-player"><option value="">Seleccionar...</option></select>
    </div>
    <div class="field-row">
      <div class="field"><label>Importe (‚Ç¨)</label><input type="number" id="inp-amount" min="1" step="1" placeholder="1"></div>
      <div class="field"><label>Fecha</label><input type="date" id="inp-date"></div>
    </div>
    <div class="field"><label>Motivo</label><input type="text" id="inp-reason" placeholder="ej: lleg√≥ tarde..."></div>
    <button class="btn-ok" onclick="addFine()">A√±adir multa</button>
    <button class="btn-cancel" onclick="closeFineModal()">Cancelar</button>
  </div>
</div>

<!-- MODAL: PAGAR MULTA -->
<div class="overlay center" id="pay-overlay">
  <div class="mbox">
    <div class="modal-title" id="pay-title">Pagar multa</div>
    <div class="modal-sub" id="pay-sub"></div>
    <div class="lives-preview" id="lives-preview"></div>
    <div class="field">
      <label>Importe pagado (‚Ç¨)</label>
      <input type="number" id="pay-amount" min="0" step="1" placeholder="0">
    </div>
    <button class="btn-ok" onclick="confirmPay()">Confirmar pago</button>
    <button class="btn-cancel" onclick="closePayModal()">Cancelar</button>
  </div>
</div>

<script>
/* ================================================================
   CONFIG
================================================================ */
const SUPA_URL     = 'https://cmfhosxslodnrxlpifrn.supabase.co';
const SUPA_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZmhvc3hzbG9kbnJ4bHBpZnJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NDY2NTQsImV4cCI6MjA4NzIyMjY1NH0.c4-Zb79UQhshpzQH79gIoro3IBKEliEjBMlhjypa_dc';
const SEASON_START = new Date('2025-07-01');

/* Emoji le√≠do desde Supabase (columna players.emoji) */
const emojiFor = name => { const p = players.find(x=>x.name===name); return p?.emoji || 'üë§'; };
/* ================================================================ */

let isAdmin = false, pinBuf = '', pendingAction = null;
let players = [], currentPayFine = null;
let ADMIN_PIN = null;
window._cached_fines = [];

/* ‚îÄ‚îÄ Supabase ‚îÄ‚îÄ */
async function sb(path, opts = {}) {
  const method  = opts.method || 'GET';
  const isWrite = ['POST','PATCH','PUT'].includes(method);
  const headers = { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY };
  if (isWrite) { headers['Content-Type'] = 'application/json'; headers['Prefer'] = 'return=representation'; }
  if (method === 'DELETE') headers['Prefer'] = 'return=minimal';
  Object.assign(headers, opts.headers || {});
  const r = await fetch(SUPA_URL + '/rest/v1/' + path, { ...opts, headers });
  if (!r.ok) { const msg = await r.text().catch(()=>r.statusText); throw new Error(`${r.status}: ${msg}`); }
  const t = await r.text(); return t ? JSON.parse(t) : [];
}

const getConfig    = ()     => sb('config?select=value&key=eq.admin_pin');
const getPlayers   = ()     => sb('players?active=eq.true&select=id,name,lives,emoji&order=name.asc');
const getAll       = ()     => sb('multas?order=date.desc');
const getLivesLog  = ()     => sb('lives_log?order=created_at.desc&limit=60');
const postFine     = d      => sb('multas', { method:'POST', body:JSON.stringify(d) });
const patchFine    = (id,d) => sb(`multas?id=eq.${id}`, { method:'PATCH', body:JSON.stringify(d) });
const deleteFineR  = id     => sb(`multas?id=eq.${id}`, { method:'DELETE' });
const patchPlayer  = (id,d) => sb(`players?id=eq.${id}`, { method:'PATCH', body:JSON.stringify(d) });
const postPlayer   = name   => sb('players', { method:'POST', body:JSON.stringify({ name }) });
const postLivesLog = d      => sb('lives_log', { method:'POST', body:JSON.stringify(d) });

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const wk   = ds => (Date.now() - new Date(ds+'T12:00:00')) / 6048e5;
const mult = ds => { const w=wk(ds); return w>=4?4:w>=2?2:1; };
const eff  = f  => f.amount * mult(f.date);
const fmt  = n  => (n%1===0?n:n.toFixed(2))+'‚Ç¨';
const fmtD = ds => new Date(ds+'T12:00:00').toLocaleDateString('es-ES',{day:'numeric',month:'short'});
const fmtDlong = ds => new Date(ds).toLocaleDateString('es-ES',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
const isSeason = ds => new Date(ds+'T12:00:00') >= SEASON_START;
const isMonth  = ds => { const d=new Date(ds+'T12:00:00'),n=new Date(); return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear(); };
const monthName= () => new Date().toLocaleDateString('es-ES',{month:'long',year:'numeric'});
const posCls   = i  => ['g','s','b'][i]||'';
const livesStr = n  => { if(!n||n<=0) return ''; const full=Math.floor(n); return '‚ù§Ô∏è'.repeat(full)+(n-full>0?'ü©∂':''); };
const playerLives = name => { const p=players.find(x=>x.name===name); return p?parseFloat(p.lives||0):0; };

/* ‚îÄ‚îÄ Render principal ‚îÄ‚îÄ */
async function render() {
  let all, pls, log;
  try {
    [all, pls, log] = await Promise.all([getAll(), getPlayers(), getLivesLog()]);
    players = pls; window._cached_fines = all;
  } catch(e) {
    console.error('Render error:', e);
    document.getElementById('h-count').textContent = 'Error de conexi√≥n ‚Äî comprueba red';
    return;
  }

  const pend  = all.filter(f=>!f.paid);
  const paid  = all.filter(f=>f.paid);
  const total = pend.reduce((s,f)=>s+eff(f),0);
  const totalLives = pls.reduce((s,p)=>s+parseFloat(p.lives||0),0);

  document.getElementById('h-total').innerHTML = fmt(total).replace('‚Ç¨','<span class="eur">‚Ç¨</span>');
  document.getElementById('h-count').textContent = pend.length+' multa'+(pend.length!==1?'s':'')+' pendiente'+(pend.length!==1?'s':'');
  const spd = pend.filter(f=>isSeason(f.date));
  const mpd = paid.filter(f=>isMonth(f.paid_at||f.date));
  document.getElementById('h-pills').innerHTML =
    `<div class="pill"><b>${spd.length}</b> esta temporada</div>
     <div class="pill"><b>${mpd.length}</b> pagadas este mes</div>
     ${totalLives>0?`<div class="pill grn"><b>${fmt(totalLives)}</b> en vidas</div>`:''}`;
  document.getElementById('month-lbl').textContent = monthName();

  renderCards(pend, pls);
  renderLives(pls, log);
  renderRanking(all, paid, pls);
  renderPlayerList(pls);
  rebuildPlayerSelect(pls);
}

/* ‚îÄ‚îÄ TARJETAS POR JUGADOR ‚îÄ‚îÄ */
function renderCards(pend, pls) {
  const el = document.getElementById('fines-list');
  if (!pend.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üéâ</div><p>sin multas pendientes</p></div>';
    return;
  }

  // Agrupar por jugador (orden alfab√©tico de players)
  const groups = {};
  pls.forEach(p => { groups[p.name] = []; });
  pend.forEach(f => { if (!groups[f.player]) groups[f.player]=[]; groups[f.player].push(f); });

  el.innerHTML = '<div class="cards-wrap">' +
    Object.entries(groups)
      .filter(([,fines]) => fines.length > 0)
      .map(([player, fines]) => {
        const sorted  = [...fines].sort((a,b) => new Date(b.date)-new Date(a.date));
        const tot     = fines.reduce((s,f) => s+eff(f), 0);
        const lives   = playerLives(player);
        const maxMult = Math.max(...fines.map(f=>mult(f.date)));
        const cardCls = maxMult===4?'all-dupe':maxMult===2?'has-dupe':'';
        const totCls  = maxMult===4?'rd':maxMult===2?'or':'';

        const finesHtml = sorted.map(f => {
          const m=mult(f.date), e=eff(f);
          const amtCls = m===4?'rd':m===2?'or':'';
          const fcCls  = m===4?'x4':m===2?'x2':'x1';
          const bdg    = m===4?`<span class="fc-badge x4">√ó4</span>`:m===2?`<span class="fc-badge x2">√ó2</span>`:'';
          const actions= isAdmin
            ? `<div class="fc-actions">
                 <button class="pbtn" onclick="openPayModal('${f.id}')">‚úì Pagar</button>
                 <button class="dbtn" onclick="delFine('${f.id}')">üóë</button>
               </div>` : '';
          return `<div class="fc ${fcCls}">
            <div class="fc-amount ${amtCls}">${fmt(e)}</div>
            <div class="fc-reason">${f.reason||'sin motivo'}</div>
            <div class="fc-meta">
              <span>${fmtD(f.date)}</span>
              ${bdg}
            </div>
            ${actions}
          </div>`;
        }).join('');

        return `<div class="player-card ${cardCls}">
          <div class="pc-header">
            <div class="pc-emoji">${emojiFor(player)}</div>
            <div class="pc-name-wrap">
              <div class="pc-name">${player}</div>
              <div class="pc-subtitle">
                <span>${fines.length} multa${fines.length!==1?'s':''}</span>
                ${lives>0?`<span>‚ù§Ô∏è ${fmt(lives)}</span>`:''}
              </div>
            </div>
            <div class="pc-right">
              <div class="pc-total ${totCls}">${fmt(tot)}</div>
            </div>
          </div>
          <div class="pc-fines-grid">${finesHtml}</div>
        </div>`;
      }).join('') +
  '</div>';
}

/* ‚îÄ‚îÄ Vidas tab ‚îÄ‚îÄ */
function renderLives(pls, log) {
  const el = document.getElementById('lives-list');
  const sorted = [...pls].sort((a,b)=>(b.lives||0)-(a.lives||0));
  el.innerHTML = sorted.map(p => {
    const lv = parseFloat(p.lives||0);
    return `<div class="lives-card">
      <div class="lives-emoji">${emojiFor(p.name)}</div>
      <div class="lives-name">${p.name}</div>
      ${lv>0
        ? `<span style="margin-right:6px;font-size:.88rem">${livesStr(lv)}</span><div class="lives-euro">${fmt(lv)}</div>`
        : `<span class="lives-zero">sin vidas</span>`}
    </div>`;
  }).join('');

  const logEl = document.getElementById('lives-log-list');
  if (!log.length) { logEl.innerHTML='<div class="loading">sin movimientos a√∫n</div>'; return; }
  logEl.innerHTML = log.map(l=>`
    <div class="log-row">
      <div class="log-delta ${l.delta>0?'pos':'neg'}">${l.delta>0?'+':''}${fmt(l.delta)}</div>
      <div class="log-info">
        <div class="log-player">${emojiFor(l.player)} ${l.player}</div>
        <div class="log-reason">${l.reason||''}</div>
      </div>
      <div class="log-date">${fmtDlong(l.created_at)}</div>
    </div>`).join('');
}

/* ‚îÄ‚îÄ Ranking ‚îÄ‚îÄ */
function renderRanking(all, paid, pls) {
  const names = pls.map(p=>p.name);

  // Temporada ‚Äî solo >0 pagado
  const sPaid = paid.filter(f=>isSeason(f.date));
  const sTot  = {};
  sPaid.forEach(f=>{sTot[f.player]=(sTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-season', sTot, true);

  // Mes ‚Äî solo >0 pagado
  const mPaid = paid.filter(f=>isMonth(f.paid_at||f.date));
  const mTot  = {};
  mPaid.forEach(f=>{mTot[f.player]=(mTot[f.player]||0)+f.amount*(f.paid_mult||1);});
  rkList('rk-month', mTot, true);

  // Deuda pendiente ‚Äî solo >0
  const mPend = all.filter(f=>!f.paid&&isMonth(f.date));
  const dTot  = {};
  mPend.forEach(f=>{dTot[f.player]=(dTot[f.player]||0)+eff(f);});
  rkList('rk-debt', dTot, false);

  // Limpios ‚Äî sin multas este mes
  const dirty = new Set(mPend.map(f=>f.player));
  const clean = names.filter(n=>!dirty.has(n));
  document.getElementById('clean-grid').innerHTML = clean.length
    ? clean.map(n=>`<div class="cc"><div class="cc-emoji">${emojiFor(n)}</div><div class="cc-name">${n.split(' ')[0]}</div></div>`).join('')
    : '<p style="color:var(--sub2);font-family:\'DM Mono\',monospace;font-size:.65rem;padding:0 0 8px 2px">nadie limpio</p>';
}

// rkList: solo muestra jugadores con importe > 0
function rkList(id, tots, desc) {
  const el = document.getElementById(id);
  let s = Object.entries(tots)
    .filter(([,v]) => v > 0)            // ‚Üê solo >0, nunca todos los jugadores
    .sort((a,b) => desc ? b[1]-a[1] : a[1]-b[1]);
  if (!s.length) {
    el.innerHTML = '<div class="rkrow"><span style="font-family:\'DM Mono\',monospace;font-size:.65rem;color:var(--sub2)">sin datos</span></div>';
    return;
  }
  el.innerHTML = s.map(([name,total],i)=>
    `<div class="rkrow">
      <span class="rkpos ${posCls(i)}">${i+1}</span>
      <span class="rk-emoji">${emojiFor(name)}</span>
      <span class="rkname">${name}</span>
      <span class="rkamt">${fmt(total)}</span>
    </div>`).join('');
}

/* ‚îÄ‚îÄ Lista jugadores (tab Equipo) ‚îÄ‚îÄ */
function renderPlayerList(pls) {
  const el = document.getElementById('player-list');
  el.innerHTML = pls.map(p=>`
    <div class="pl-row">
      <span class="pl-emoji">${emojiFor(p.name)}</span>
      <div class="pl-name">${p.name}</div>
      ${parseFloat(p.lives||0)>0?`<span class="pl-lives-badge">‚ù§Ô∏è ${fmt(parseFloat(p.lives))}</span>`:''}
      ${isAdmin?`<button class="pl-del" onclick="delPlayer('${p.id}')">Baja</button>`:''}
    </div>`).join('');
  document.getElementById('add-player-row').style.display = isAdmin ? 'flex' : 'none';
}

function rebuildPlayerSelect(pls) {
  const sel = document.getElementById('inp-player');
  // Preservar valor seleccionado si existe
  const prev = sel.value;
  sel.innerHTML = '<option value="">Seleccionar jugador...</option>';
  pls.forEach(p => {
    const o = document.createElement('option');
    o.value = p.name; o.textContent = emojiFor(p.name) + ' ' + p.name;
    sel.appendChild(o);
  });
  // Restaurar selecci√≥n si segu√≠a siendo v√°lida
  if (prev) sel.value = prev;
}

/* ‚îÄ‚îÄ Pagar multa con vidas ‚îÄ‚îÄ */
function openPayModal(fineId) {
  const f = (window._cached_fines||[]).find(x=>x.id===fineId);
  if (!f) { alert('No se encontr√≥ la multa. Recarga la p√°gina.'); return; }
  currentPayFine = f;
  const e = eff(f), lives = playerLives(f.player);
  const useLives = Math.min(lives, e), toPay = Math.max(0, e-useLives);
  document.getElementById('pay-title').textContent = `Pagar ‚Äî ${f.player}`;
  document.getElementById('pay-sub').textContent   = `Multa: ${fmt(e)}`;
  document.getElementById('pay-amount').value      = toPay;
  const prev = document.getElementById('lives-preview');
  if (lives > 0) {
    prev.style.display = 'block';
    prev.innerHTML = lives >= e
      ? `‚ù§Ô∏è Cubre la multa entera. Pago real: <b>${fmt(toPay)}</b>`
      : `‚ù§Ô∏è ${fmt(useLives)} en vidas se usar√°n. Resto: <b>${fmt(toPay)}</b>`;
  } else { prev.style.display='none'; }
  document.getElementById('pay-overlay').classList.add('on');
}
function closePayModal() { document.getElementById('pay-overlay').classList.remove('on'); currentPayFine=null; }
document.getElementById('pay-overlay').addEventListener('click', e=>{ if(e.target===e.currentTarget) closePayModal(); });

document.getElementById('pay-amount').addEventListener('input', () => {
  if (!currentPayFine) return;
  const f=currentPayFine, e=eff(f), lives=playerLives(f.player);
  const paid_in=parseFloat(document.getElementById('pay-amount').value)||0;
  const useLives=Math.min(lives,e), total_in=paid_in+useLives, excess=Math.max(0,total_in-e);
  const prev=document.getElementById('lives-preview');
  if (lives>0||excess>0) {
    prev.style.display='block';
    let msg='';
    if (useLives>0) msg+=`‚ù§Ô∏è Usa ${fmt(useLives)} en vidas. `;
    if (excess>0)   msg+=`<b>+${fmt(excess)} vidas nuevas</b> por exceso.`;
    if (!msg)       msg='Sin vidas aplicadas.';
    prev.innerHTML=msg;
  }
});

async function confirmPay() {
  if (!currentPayFine) return;
  const f=currentPayFine, e=eff(f), lives=playerLives(f.player);
  const paid_in=parseFloat(document.getElementById('pay-amount').value)||0;
  const useLives=Math.min(lives,e), total_in=paid_in+useLives;
  const excess=Math.max(0,total_in-e), newLives=lives-useLives+excess;
  const player=players.find(p=>p.name===f.player);
  const today=new Date().toISOString().split('T')[0], pm=mult(f.date);
  try {
    await patchFine(f.id, {paid:true,paid_mult:pm,paid_at:today,paid_amount:total_in});
    if (player) await patchPlayer(player.id, {lives:newLives});
    const logEntries=[];
    if (useLives>0) logEntries.push({player:f.player,player_id:player?.id,delta:-useLives,reason:`Vidas usadas: "${f.reason||'sin motivo'}" (${fmt(e)})`});
    if (excess>0)   logEntries.push({player:f.player,player_id:player?.id,delta:excess,reason:`Exceso pagado ‚Üí nuevas vidas (${fmt(excess)})`});
    for (const entry of logEntries) await postLivesLog(entry);
    closePayModal(); render();
  } catch(err) { alert('Error: '+err.message); }
}

/* ‚îÄ‚îÄ Acciones ‚îÄ‚îÄ */
async function delFine(id) {
  if (!confirm('¬øEliminar esta multa?')) return;
  await deleteFineR(id); render();
}
async function addFine() {
  const p=document.getElementById('inp-player').value;
  const a=parseFloat(document.getElementById('inp-amount').value);
  const d=document.getElementById('inp-date').value;
  const r=document.getElementById('inp-reason').value.trim();
  if (!p) return alert('Selecciona un jugador');
  if (!a||a<=0) return alert('Importe inv√°lido');
  if (!d) return alert('Selecciona una fecha');
  try { await postFine({player:p,amount:a,date:d,reason:r}); closeFineModal(); render(); }
  catch(e) { alert('Error: '+e.message); }
}
async function addPlayer() {
  const n=document.getElementById('new-player-name').value.trim();
  if (!n) return;
  try { await postPlayer(n); document.getElementById('new-player-name').value=''; render(); }
  catch(e) { alert('Error: '+e.message); }
}
async function delPlayer(id) {
  if (!confirm('¬øDar de baja este jugador?')) return;
  await patchPlayer(id,{active:false}); render();
}

/* ‚îÄ‚îÄ FAB / admin ‚îÄ‚îÄ */
function fabTap() { if(isAdmin){openFineModal();return;} pendingAction='fine'; openPin(); }
function logoutAdmin() { isAdmin=false; updUI(); }

/* ‚îÄ‚îÄ Modal multa ‚îÄ‚îÄ */
function openFineModal() {
  document.getElementById('inp-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('inp-amount').value = '1';
  // NO resetear inp-player aqu√≠ para no forzar doble selecci√≥n ‚Äî se preserva en rebuildPlayerSelect
  document.getElementById('inp-reason').value = '';
  document.getElementById('fine-overlay').classList.add('on');
}
function closeFineModal() { document.getElementById('fine-overlay').classList.remove('on'); }
document.getElementById('fine-overlay').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeFineModal(); });

/* ‚îÄ‚îÄ PIN ‚îÄ‚îÄ */
function openPin()  { pinBuf=''; updDots(); document.getElementById('pin-err').textContent=''; document.getElementById('pin-overlay').classList.add('on'); }
function closePin() { document.getElementById('pin-overlay').classList.remove('on'); pendingAction=null; }
function updDots()  { for(let i=0;i<4;i++) document.getElementById('d'+i).classList.toggle('on',i<pinBuf.length); }
function pinPress(v) {
  if (v==='del') { pinBuf=pinBuf.slice(0,-1); updDots(); return; }
  if (pinBuf.length>=4) return;
  pinBuf+=v; updDots();
  if (pinBuf.length===4) {
    setTimeout(()=>{
      if (!ADMIN_PIN) { document.getElementById('pin-err').textContent='PIN cargando, espera'; pinBuf=''; updDots(); return; }
      if (pinBuf===ADMIN_PIN) {
        isAdmin=true; closePin(); updUI();
        if (pendingAction==='fine') { pendingAction=null; openFineModal(); }
      } else {
        document.getElementById('pin-err').textContent='PIN incorrecto';
        pinBuf=''; updDots();
      }
    }, 150);
  }
}
function updUI() { document.getElementById('admin-badge').classList.toggle('on',isAdmin); render(); }

/* ‚îÄ‚îÄ Pages ‚îÄ‚îÄ */
function goPage(n,btn) {
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.ni').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+n).classList.add('on');
  btn.classList.add('on');
}

/* ‚îÄ‚îÄ PIN grid ‚îÄ‚îÄ */
[1,2,3,4,5,6,7,8,9,'del',0,'ok'].forEach(k=>{
  if(k==='ok'){document.getElementById('pin-grid').appendChild(document.createElement('div'));return;}
  const b=document.createElement('button');
  b.className='pk'+(k==='del'?' del':'');
  b.textContent=k==='del'?'‚å´':k;
  b.onclick=()=>pinPress(String(k));
  document.getElementById('pin-grid').appendChild(b);
});

/* ‚îÄ‚îÄ Config (PIN desde Supabase) ‚îÄ‚îÄ */
async function loadConfig() {
  try { const rows=await getConfig(); if(rows?.length) ADMIN_PIN=rows[0].value; }
  catch(e) { console.warn('Config:', e); }
}

/* ‚îÄ‚îÄ PWA ‚îÄ‚îÄ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('sw.js').catch(()=>{}); });
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
loadConfig();
render();
setInterval(render, 30000);
</script>
</body>
</html>
